const m=(t,n=0)=>{const e=Number(t);return Number.isFinite(e)?e:n},v=(t,n=!1)=>{if(typeof t=="boolean")return t;if(typeof t!="string")return n;const e=t.trim().toLowerCase();return e===""||e==="true"||e==="1"||e==="yes"?!0:e==="false"||e==="0"||e==="no"?!1:n},h={pageTitle:"Vantage",header:{title:"",description:""},context:{introText:"",emptyText:"No context for this keyframe."},renderer:{loading:"Loading renderer"},credits:{label:`Â© OpenStreetMap contributors 

 Realised with [Vantage](https://vantage.thometnanni.net/).`},theme:{pageBg:"#000",sceneBg:"#000",panelFill:"#000",panelStroke:"#000",text:"#fff",mutedText:"#ccc",accent:"#fff",contextBg:"#000",contextText:"#fff",contextMuted:"#ccc"}},p=t=>typeof t=="string"?t.trim():"",u=(t,n)=>{const e=p(t);return e.length>0?e:n},y=t=>{if(Array.isArray(t))return t.map(e=>m(e,0)).join(" ");const n=p(t);return n.length===0?n:n.replaceAll(","," ").replace(/\s+/g," ").trim()},x=t=>{const n=p(t);if(n.length>0)return{markdown:n};if(!t||typeof t!="object")return null;const e=p(t.title),r=p(t.markdown??t.text??t.body??t.comment??t.notes);return e.length===0&&r.length===0?null:{...e.length>0?{title:e}:{},...r.length>0?{markdown:r}:{}}},T=t=>{const n=y(t==null?void 0:t.position),e=y(t==null?void 0:t.rotation);return n.length>0&&e.length>0},P=(t,n)=>{const e={...t,time:m(t.time,n)},r=y(t.position),s=y(t.rotation);r.length>0&&(e.position=r),s.length>0&&(e.rotation=s);const o=m(t.scrollWeight??t.scroll_weight,Number.NaN);Number.isFinite(o)&&o>0?e.scrollWeight=o:delete e.scrollWeight;const a=m(t.pause??t.pauseWeight??t.hold,Number.NaN);Number.isFinite(a)&&a>0?e.pause=a:delete e.pause;const i=x(t.context)??x({title:t.commentTitle??t.title,markdown:t.comment??t.notes??t.text??t.markdown});return i?e.context=i:delete e.context,e},I=t=>{const n=p(t);if(n.length===0)return"";if(/^(https?:|data:|blob:|\/\/|file:)/i.test(n))return n;const e=n.indexOf("?"),r=n.indexOf("#"),s=[e,r].filter(M=>M>=0).sort((M,A)=>M-A)[0],o=s==null?n:n.slice(0,s),a=s==null?"":n.slice(s),i=o.replace(/^\.\//,"").replace(/^\/+/,""),c=i.lastIndexOf("/"),d=c>=0?i.slice(0,c+1):"";let l=c>=0?i.slice(c+1):i;const f="live_view_upload-",g=l.indexOf(f),b=g>=0?l.indexOf(f,g+f.length):-1;return b>0&&(l=l.slice(b)),`/${d}${l}${a}`},F=t=>{const n=t&&typeof t=="object"?t:{},e=c=>c&&typeof c=="object"?c:{},r=e(n.header),s=e(n.context),o=e(n.renderer),a=e(n.credits),i=e(n.theme);return{pageTitle:u(n.pageTitle,h.pageTitle),header:{title:u(r.title,h.header.title),description:p(r.description)},context:{introText:p(s.introText),emptyText:u(s.emptyText,h.context.emptyText)},renderer:{loading:u(o.loading,h.renderer.loading)},credits:{label:u(a.label,h.credits.label),href:u(a.href,h.credits.href)},theme:{pageBg:u(i.pageBg,h.theme.pageBg),sceneBg:u(i.sceneBg,h.theme.sceneBg),panelFill:u(i.panelFill,h.theme.panelFill),panelStroke:u(i.panelStroke,h.theme.panelStroke),text:u(i.text,h.theme.text),mutedText:u(i.mutedText,h.theme.mutedText),accent:u(i.accent,h.theme.accent),contextBg:u(i.contextBg,u(i.pageBg,h.theme.contextBg)),contextText:u(i.contextText,u(i.text,h.theme.contextText)),contextMuted:u(i.contextMuted,u(i.mutedText,h.theme.contextMuted))}}},C=(t,n)=>{const e=t.id??`projection-${n+1}`,r=m(t.time,0),s=m(t.startTime,r),o=I(t.src),a=I(t.previewSrc)||o,i=Array.isArray(t.keyframes)?t.keyframes.map((d,l)=>P(d,l)):[],c=x(t.context);return{...t,id:e,label:t.label??e,src:o,previewSrc:a,projectionType:t.projectionType??"perspective",time:r,startTime:s,focus:v(t.focus,!1),cameraPath:t.cameraPath===!0,cameraSelectable:t.cameraSelectable!==!1,...c?{context:c}:{},keyframes:i}},B=t=>{const n=t.flatMap(e=>{const r=e.keyframes.map(s=>m(s.time,0)+e.time);return[e.startTime,e.time,...r]});return Math.max(0,...n)},w=(t,n)=>{const e={...t,time:n,opacity:0,screen:!1};return T(e)||(delete e.position,delete e.rotation),e},z=t=>{if(t.length<=1)return t;const n=[...t].sort((s,o)=>m(s.time,0)-m(o.time,0));if(new Set(n.map(s=>m(s.time,0).toFixed(6))).size<=1)return n.map((s,o)=>({...s,time:o}));let r=m(n[0].time,0);return n.map((s,o)=>{if(o===0)return{...s,time:r};const a=m(s.time,r+.001),i=a<=r?r+.001:a;return r=i,{...s,time:i}})},O=t=>t.map((n,e)=>({projection:n,index:e})).sort((n,e)=>{const r=m(n.projection.startTime,0)-m(e.projection.startTime,0);return Math.abs(r)>1e-6?r:n.index-e.index}).map(({projection:n})=>n),k=t=>{if(!t||t.projectionType!=="perspective")return null;const n=t.keyframes.filter(s=>T(s)).map(s=>w(s,m(s.time,0)+m(t.time,0)));if(n.length===0)return null;const e=z(n),r=t.src||t.previewSrc;return{...t,id:t.id,label:t.label??"Camera Path",src:r,previewSrc:t.previewSrc||r,projectionType:"perspective",time:0,startTime:0,cameraSelectable:!1,cameraPath:!0,focus:!0,opacity:0,keyframes:e}},R=t=>{const n=O(t.filter(o=>o.projectionType==="perspective"&&o.cameraSelectable!==!1&&o.keyframes.some(a=>T(a))));if(n.length===0)return null;const e=n.map((o,a)=>{const i=o.keyframes.find(d=>T(d)),c=x(i==null?void 0:i.context)??x(o.context);return{...w(i,a),...c?{context:c}:{}}}),r=n[0],s=r.src||r.previewSrc;return{id:"camera-path",label:"Camera Path",src:s,previewSrc:r.previewSrc||s,projectionType:"perspective",time:0,startTime:0,cameraSelectable:!1,cameraPath:!0,focus:!0,opacity:0,keyframes:e}},$=(t,n)=>{const e=p(t.cameraPathProjectionId),r=e.length>0?n.find(l=>l.id===e):null,s=n.find(l=>l.cameraPath===!0),o=n.find(l=>l.focus===!0&&l.projectionType==="perspective"&&l.keyframes.some(f=>T(f))),a=n.filter(l=>l.projectionType==="perspective"&&l.keyframes.some(f=>T(f))).sort((l,f)=>f.keyframes.length-l.keyframes.length)[0],i=r??s??o??a??null,c=i?k(i):null;if(c&&c.keyframes.length>=2)return c;const d=R(n);return d||c},D=(t,n)=>{const e=Math.max(1,m(n,1));if(!t||!Array.isArray(t.keyframes))return{start:0,end:e,duration:e};const r=t.keyframes.map(i=>m(i.time,Number.NaN)).filter(i=>Number.isFinite(i));if(r.length===0)return{start:0,end:e,duration:e};const s=Math.min(...r),o=Math.max(...r),a=o>s?o:s+e;return{start:s,end:a,duration:Math.max(1e-6,a-s)}},N=t=>{const n=y(t);if(n.length===0)return null;const e=n.split(" ").map(r=>m(r,Number.NaN));return e.some(r=>!Number.isFinite(r))?null:e},S=(t,n)=>{const e=Math.PI*2;let r=(t-n)%e;return r>Math.PI&&(r-=e),r<-Math.PI&&(r+=e),Math.abs(r)},K=(t,n)=>{if(!t||!n)return Number.POSITIVE_INFINITY;const e=N(t.position),r=N(n.position),s=N(t.rotation),o=N(n.rotation);if(!e||!r||!s||!o)return Number.POSITIVE_INFINITY;const a=Math.hypot(e[0]-r[0],e[1]-r[1],e[2]-r[2]),i=S(s[0],o[0])+S(s[1],o[1])+S(s[2],o[2]);return a+i*20},V=(t,n,e)=>{if(!n||!Array.isArray(n.keyframes))return[];const r=n.keyframes.map(o=>({keyframe:o,time:m(o.time,e.start)})).filter(({keyframe:o})=>T(o));return r.length===0?[]:(Array.isArray(t)?t:[]).filter(o=>o.projectionType==="perspective"&&o.id!==n.id).map(o=>{const a=o.keyframes.find(d=>T(d)),i=x(a==null?void 0:a.context)??x(o.context);if(!a||!i)return null;let c=null;for(const d of r){const l=K(a,d.keyframe);(!c||l<c.distance)&&(c={...d,distance:l})}return c?{id:`moment-${o.id}`,time:c.time,progress:Math.max(0,Math.min(1,(c.time-e.start)/e.duration)),context:i}:null}).filter(Boolean).sort((o,a)=>o.time-a.time)},_=(t,n,e)=>{const r=x(t.context)??x({title:t.commentTitle??t.title,markdown:t.comment??t.notes??t.text??t.markdown}),s=Number(t.time??t.at),o=Number(t.progress),a=n===0?0:n/Math.max(1,e.count-1),i=Number.isFinite(o)?Math.max(0,Math.min(1,o)):a,c=Number.isFinite(s)?s:e.start+i*e.duration;return{id:p(t.id)||`moment-${n+1}`,time:c,progress:Math.max(0,Math.min(1,(c-e.start)/e.duration)),context:r}},q=(t,n,e,r)=>{var c;const s=Array.isArray((c=t==null?void 0:t.narrative)==null?void 0:c.moments)?t.narrative.moments:Array.isArray(t==null?void 0:t.moments)?t.moments:[];if(s.length>0)return s.map((l,f)=>_(l,f,{...e,count:s.length})).sort((l,f)=>l.time-f.time);if(!n||!Array.isArray(n.keyframes))return[];const o=n.keyframes.map((d,l)=>{const f=m(d.time,e.start);return{id:`moment-${l+1}`,time:f,progress:Math.max(0,Math.min(1,(f-e.start)/e.duration)),context:x(d.context)}}),a=o.filter(d=>d.context!=null),i=V(r,n,e);if(a.length>0){if(i.length===0)return a;const d=1e-4,l=g=>a.some(b=>Math.abs(m(b.time,Number.NaN)-g)<=d);return[...a,...i.filter(g=>!l(m(g.time,Number.NaN)))].sort((g,b)=>g.time-b.time)}return i.length>0?i:o},E=(t={})=>{const n=(Array.isArray(t.projections)?t.projections:[]).map(C),e=n.filter(i=>i.cameraSelectable).sort((i,c)=>i.startTime-c.startTime),r=B(n),s=$(t,n),o=D(s,Math.max(r,m(t.maxTimelineTime,0))),a=q(t,s,o,n);return{sceneSrc:I(t.sceneSrc),maxTimelineTime:Math.max(m(t.maxTimelineTime,0),r,o.end),projections:n,cameraTracks:e,cameraPathProjectionId:(s==null?void 0:s.id)??"",cameraPathProjection:s,cameraPathRange:o,narrativeMoments:a,ui:F(t.ui)}};export{E as r};
