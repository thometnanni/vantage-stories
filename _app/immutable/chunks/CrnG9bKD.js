const m=(t,r=0)=>{const e=Number(t);return Number.isFinite(e)?e:r},v=(t,r=!1)=>{if(typeof t=="boolean")return t;if(typeof t!="string")return r;const e=t.trim().toLowerCase();return e===""||e==="true"||e==="1"||e==="yes"?!0:e==="false"||e==="0"||e==="no"?!1:r},h={pageTitle:"Vantage",header:{title:"",description:""},context:{introText:"",emptyText:"No context for this keyframe."},renderer:{loading:"Loading renderer"},credits:{label:`Â© OpenStreetMap contributors 

 Realised with [Vantage](https://vantage.thometnanni.net/).`},theme:{pageBg:"#000",sceneBg:"#000",panelFill:"#000",panelStroke:"#000",text:"#fff",mutedText:"#ccc",accent:"#fff",contextBg:"#000",contextText:"#fff",contextMuted:"#ccc"}},A={mode:"scrub",durationMs:1200,easing:"linear"},p=t=>typeof t=="string"?t.trim():"",u=(t,r)=>{const e=p(t);return e.length>0?e:r},P=t=>{const r=t&&typeof t=="object"?t:{},n=p(r.mode).toLowerCase()==="triggered"?"triggered":"scrub",s=Math.max(120,Math.min(1e4,m(r.durationMs??r.duration??r.transitionMs,A.durationMs))),o=u(r.easing,A.easing);return{mode:n,durationMs:s,easing:o}},y=t=>{if(Array.isArray(t))return t.map(e=>m(e,0)).join(" ");const r=p(t);return r.length===0?r:r.replaceAll(","," ").replace(/\s+/g," ").trim()},x=t=>{const r=p(t);if(r.length>0)return{markdown:r};if(!t||typeof t!="object")return null;const e=p(t.title),n=p(t.markdown??t.text??t.body??t.comment??t.notes);return e.length===0&&n.length===0?null:{...e.length>0?{title:e}:{},...n.length>0?{markdown:n}:{}}},T=t=>{const r=y(t==null?void 0:t.position),e=y(t==null?void 0:t.rotation);return r.length>0&&e.length>0},F=(t,r)=>{const e={...t,time:m(t.time,r)},n=y(t.position),s=y(t.rotation);n.length>0&&(e.position=n),s.length>0&&(e.rotation=s);const o=m(t.scrollWeight??t.scroll_weight,Number.NaN);Number.isFinite(o)&&o>0?e.scrollWeight=o:delete e.scrollWeight;const a=m(t.pause??t.pauseWeight??t.hold,Number.NaN);Number.isFinite(a)&&a>0?e.pause=a:delete e.pause;const i=x(t.context)??x({title:t.commentTitle??t.title,markdown:t.comment??t.notes??t.text??t.markdown});return i?e.context=i:delete e.context,e},w=t=>{const r=p(t);if(r.length===0)return"";if(/^(https?:|data:|blob:|\/\/|file:)/i.test(r))return r;const e=r.indexOf("?"),n=r.indexOf("#"),s=[e,n].filter(N=>N>=0).sort((N,C)=>N-C)[0],o=s==null?r:r.slice(0,s),a=s==null?"":r.slice(s),i=o.replace(/^\.\//,"").replace(/^\/+/,""),c=i.lastIndexOf("/"),d=c>=0?i.slice(0,c+1):"";let l=c>=0?i.slice(c+1):i;const f="live_view_upload-",g=l.indexOf(f),b=g>=0?l.indexOf(f,g+f.length):-1;return b>0&&(l=l.slice(b)),`/${d}${l}${a}`},B=t=>{const r=t&&typeof t=="object"?t:{},e=c=>c&&typeof c=="object"?c:{},n=e(r.header),s=e(r.context),o=e(r.renderer),a=e(r.credits),i=e(r.theme);return{pageTitle:u(r.pageTitle,h.pageTitle),header:{title:u(n.title,h.header.title),description:p(n.description)},context:{introText:p(s.introText),emptyText:u(s.emptyText,h.context.emptyText)},renderer:{loading:u(o.loading,h.renderer.loading)},credits:{label:u(a.label,h.credits.label),href:u(a.href,h.credits.href)},theme:{pageBg:u(i.pageBg,h.theme.pageBg),sceneBg:u(i.sceneBg,h.theme.sceneBg),panelFill:u(i.panelFill,h.theme.panelFill),panelStroke:u(i.panelStroke,h.theme.panelStroke),text:u(i.text,h.theme.text),mutedText:u(i.mutedText,h.theme.mutedText),accent:u(i.accent,h.theme.accent),contextBg:u(i.contextBg,u(i.pageBg,h.theme.contextBg)),contextText:u(i.contextText,u(i.text,h.theme.contextText)),contextMuted:u(i.contextMuted,u(i.mutedText,h.theme.contextMuted))}}},z=(t,r)=>{const e=t.id??`projection-${r+1}`,n=m(t.time,0),s=m(t.startTime,n),o=w(t.src),a=w(t.previewSrc)||o,i=Array.isArray(t.keyframes)?t.keyframes.map((d,l)=>F(d,l)):[],c=x(t.context);return{...t,id:e,label:t.label??e,src:o,previewSrc:a,projectionType:t.projectionType??"perspective",time:n,startTime:s,focus:v(t.focus,!1),cameraPath:t.cameraPath===!0,cameraSelectable:t.cameraSelectable!==!1,...c?{context:c}:{},keyframes:i}},O=t=>{const r=t.flatMap(e=>{const n=e.keyframes.map(s=>m(s.time,0)+e.time);return[e.startTime,e.time,...n]});return Math.max(0,...r)},I=(t,r)=>{const e={...t,time:r,opacity:0,screen:!1};return T(e)||(delete e.position,delete e.rotation),e},R=t=>{if(t.length<=1)return t;const r=[...t].sort((s,o)=>m(s.time,0)-m(o.time,0));if(new Set(r.map(s=>m(s.time,0).toFixed(6))).size<=1)return r.map((s,o)=>({...s,time:o}));let n=m(r[0].time,0);return r.map((s,o)=>{if(o===0)return{...s,time:n};const a=m(s.time,n+.001),i=a<=n?n+.001:a;return n=i,{...s,time:i}})},k=t=>t.map((r,e)=>({projection:r,index:e})).sort((r,e)=>{const n=m(r.projection.startTime,0)-m(e.projection.startTime,0);return Math.abs(n)>1e-6?n:r.index-e.index}).map(({projection:r})=>r),L=t=>{if(!t||t.projectionType!=="perspective")return null;const r=t.keyframes.filter(s=>T(s)).map(s=>I(s,m(s.time,0)+m(t.time,0)));if(r.length===0)return null;const e=R(r),n=t.src||t.previewSrc;return{...t,id:t.id,label:t.label??"Camera Path",src:n,previewSrc:t.previewSrc||n,projectionType:"perspective",time:0,startTime:0,cameraSelectable:!1,cameraPath:!0,focus:!0,opacity:0,keyframes:e}},_=t=>{const r=k(t.filter(o=>o.projectionType==="perspective"&&o.cameraSelectable!==!1&&o.keyframes.some(a=>T(a))));if(r.length===0)return null;const e=r.map((o,a)=>{const i=o.keyframes.find(d=>T(d)),c=x(i==null?void 0:i.context)??x(o.context);return{...I(i,a),...c?{context:c}:{}}}),n=r[0],s=n.src||n.previewSrc;return{id:"camera-path",label:"Camera Path",src:s,previewSrc:n.previewSrc||s,projectionType:"perspective",time:0,startTime:0,cameraSelectable:!1,cameraPath:!0,focus:!0,opacity:0,keyframes:e}},D=(t,r)=>{const e=p(t.cameraPathProjectionId),n=e.length>0?r.find(l=>l.id===e):null,s=r.find(l=>l.cameraPath===!0),o=r.find(l=>l.focus===!0&&l.projectionType==="perspective"&&l.keyframes.some(f=>T(f))),a=r.filter(l=>l.projectionType==="perspective"&&l.keyframes.some(f=>T(f))).sort((l,f)=>f.keyframes.length-l.keyframes.length)[0],i=n??s??o??a??null,c=i?L(i):null;if(c&&c.keyframes.length>=2)return c;const d=_(r);return d||c},E=(t,r)=>{const e=Math.max(1,m(r,1));if(!t||!Array.isArray(t.keyframes))return{start:0,end:e,duration:e};const n=t.keyframes.map(i=>m(i.time,Number.NaN)).filter(i=>Number.isFinite(i));if(n.length===0)return{start:0,end:e,duration:e};const s=Math.min(...n),o=Math.max(...n),a=o>s?o:s+e;return{start:s,end:a,duration:Math.max(1e-6,a-s)}},M=t=>{const r=y(t);if(r.length===0)return null;const e=r.split(" ").map(n=>m(n,Number.NaN));return e.some(n=>!Number.isFinite(n))?null:e},S=(t,r)=>{const e=Math.PI*2;let n=(t-r)%e;return n>Math.PI&&(n-=e),n<-Math.PI&&(n+=e),Math.abs(n)},$=(t,r)=>{if(!t||!r)return Number.POSITIVE_INFINITY;const e=M(t.position),n=M(r.position),s=M(t.rotation),o=M(r.rotation);if(!e||!n||!s||!o)return Number.POSITIVE_INFINITY;const a=Math.hypot(e[0]-n[0],e[1]-n[1],e[2]-n[2]),i=S(s[0],o[0])+S(s[1],o[1])+S(s[2],o[2]);return a+i*20},K=(t,r,e)=>{if(!r||!Array.isArray(r.keyframes))return[];const n=r.keyframes.map(o=>({keyframe:o,time:m(o.time,e.start)})).filter(({keyframe:o})=>T(o));return n.length===0?[]:(Array.isArray(t)?t:[]).filter(o=>o.projectionType==="perspective"&&o.id!==r.id).map(o=>{const a=o.keyframes.find(d=>T(d)),i=x(a==null?void 0:a.context)??x(o.context);if(!a||!i)return null;let c=null;for(const d of n){const l=$(a,d.keyframe);(!c||l<c.distance)&&(c={...d,distance:l})}return c?{id:`moment-${o.id}`,time:c.time,progress:Math.max(0,Math.min(1,(c.time-e.start)/e.duration)),context:i}:null}).filter(Boolean).sort((o,a)=>o.time-a.time)},V=(t,r,e)=>{const n=x(t.context)??x({title:t.commentTitle??t.title,markdown:t.comment??t.notes??t.text??t.markdown}),s=Number(t.time??t.at),o=Number(t.progress),a=r===0?0:r/Math.max(1,e.count-1),i=Number.isFinite(o)?Math.max(0,Math.min(1,o)):a,c=Number.isFinite(s)?s:e.start+i*e.duration;return{id:p(t.id)||`moment-${r+1}`,time:c,progress:Math.max(0,Math.min(1,(c-e.start)/e.duration)),context:n}},q=(t,r,e,n)=>{var c;const s=Array.isArray((c=t==null?void 0:t.narrative)==null?void 0:c.moments)?t.narrative.moments:Array.isArray(t==null?void 0:t.moments)?t.moments:[];if(s.length>0)return s.map((l,f)=>V(l,f,{...e,count:s.length})).sort((l,f)=>l.time-f.time);if(!r||!Array.isArray(r.keyframes))return[];const o=r.keyframes.map((d,l)=>{const f=m(d.time,e.start);return{id:`moment-${l+1}`,time:f,progress:Math.max(0,Math.min(1,(f-e.start)/e.duration)),context:x(d.context)}}),a=o.filter(d=>d.context!=null),i=K(n,r,e);if(a.length>0){if(i.length===0)return a;const d=1e-4,l=g=>a.some(b=>Math.abs(m(b.time,Number.NaN)-g)<=d);return[...a,...i.filter(g=>!l(m(g.time,Number.NaN)))].sort((g,b)=>g.time-b.time)}return i.length>0?i:o},U=(t={})=>{const r=(Array.isArray(t.projections)?t.projections:[]).map(z),e=r.filter(i=>i.cameraSelectable).sort((i,c)=>i.startTime-c.startTime),n=O(r),s=D(t,r),o=E(s,Math.max(n,m(t.maxTimelineTime,0))),a=q(t,s,o,r);return{sceneSrc:w(t.sceneSrc),maxTimelineTime:Math.max(m(t.maxTimelineTime,0),n,o.end),projections:r,cameraTracks:e,cameraPathProjectionId:(s==null?void 0:s.id)??"",cameraPathProjection:s,cameraPathRange:o,narrativeMoments:a,cameraControl:P(t.cameraControl),ui:B(t.ui)}};export{U as r};
