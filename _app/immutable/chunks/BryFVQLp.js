var Wt=Object.defineProperty;var it=c=>{throw TypeError(c)};var qt=(c,e,t)=>e in c?Wt(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t;var m=(c,e,t)=>qt(c,typeof e!="symbol"?e+"":e,t),nt=(c,e,t)=>e.has(c)||it("Cannot "+t);var y=(c,e,t)=>(nt(c,e,"read from private field"),t?t.call(c):e.get(c)),D=(c,e,t)=>e.has(c)?it("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(c):e.set(c,t),I=(c,e,t,s)=>(nt(c,e,"write to private field"),s?s.call(c,t):e.set(c,t),t);import{R as Zt,P as Je,V as v,C as et,M as k,T as G,Q as ge,S as rt,a as C,b as Et,E as Qt,c as ze,d as J,e as $t,f as Ye,g as vt,L as Jt,h as Ee,F as xt,i as te,j as q,k as es,l as ts,D as Xe,m as oe,n as ve,o as K,I as ss,p as is,O as wt,q as Mt,r as ns,B as Ne,s as rs,t as Ve,u as Ct,v as We,N as je,w as os,x as Fe,y as Rt,z as Pt,A as Ot,G as as,H as cs,J as hs,K as tt,U as St,W as ls,X as us,Y as ds,Z as he,_ as xe,$ as Lt,a0 as ps,a1 as fs,a2 as ms,a3 as jt,a4 as ot,a5 as gs,a6 as ys,a7 as bs,a8 as As,a9 as Ts,aa as _s,ab as Es,ac as vs,ad as qe,ae as at,af as ct,ag as ht,ah as kt,ai as xs,aj as ws,ak as Ms,al as Cs,am as Rs,an as Ps,ao as Os,ap as Ss,aq as Ls,ar as js,as as lt,at as ks,au as Ds,av as Is,aw as Ns,ax as Fs,ay as Hs}from"./DUYSfaJJ.js";const ut={type:"change"},st={type:"start"},Dt={type:"end"},Pe=new Zt,dt=new Je,Gs=Math.cos(70*Et.DEG2RAD),R=new v,L=2*Math.PI,x={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6},He=1e-6;class Us extends et{constructor(e,t=null){super(e,t),this.state=x.NONE,this.enabled=!0,this.target=new v,this.cursor=new v,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.keyRotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:k.ROTATE,MIDDLE:k.DOLLY,RIGHT:k.PAN},this.touches={ONE:G.ROTATE,TWO:G.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this._lastPosition=new v,this._lastQuaternion=new ge,this._lastTargetPosition=new v,this._quat=new ge().setFromUnitVectors(e.up,new v(0,1,0)),this._quatInverse=this._quat.clone().invert(),this._spherical=new rt,this._sphericalDelta=new rt,this._scale=1,this._panOffset=new v,this._rotateStart=new C,this._rotateEnd=new C,this._rotateDelta=new C,this._panStart=new C,this._panEnd=new C,this._panDelta=new C,this._dollyStart=new C,this._dollyEnd=new C,this._dollyDelta=new C,this._dollyDirection=new v,this._mouse=new C,this._performCursorZoom=!1,this._pointers=[],this._pointerPositions={},this._controlActive=!1,this._onPointerMove=Bs.bind(this),this._onPointerDown=Ks.bind(this),this._onPointerUp=zs.bind(this),this._onContextMenu=Qs.bind(this),this._onMouseWheel=Vs.bind(this),this._onKeyDown=Ws.bind(this),this._onTouchStart=qs.bind(this),this._onTouchMove=Zs.bind(this),this._onMouseDown=Ys.bind(this),this._onMouseMove=Xs.bind(this),this._interceptControlDown=$s.bind(this),this._interceptControlUp=Js.bind(this),this.domElement!==null&&this.connect(),this.update()}connect(){this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointercancel",this._onPointerUp),this.domElement.addEventListener("contextmenu",this._onContextMenu),this.domElement.addEventListener("wheel",this._onMouseWheel,{passive:!1}),this.domElement.getRootNode().addEventListener("keydown",this._interceptControlDown,{passive:!0,capture:!0}),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.removeEventListener("pointercancel",this._onPointerUp),this.domElement.removeEventListener("wheel",this._onMouseWheel),this.domElement.removeEventListener("contextmenu",this._onContextMenu),this.stopListenToKeyEvents(),this.domElement.getRootNode().removeEventListener("keydown",this._interceptControlDown,{capture:!0}),this.domElement.style.touchAction="auto"}dispose(){this.disconnect()}getPolarAngle(){return this._spherical.phi}getAzimuthalAngle(){return this._spherical.theta}getDistance(){return this.object.position.distanceTo(this.target)}listenToKeyEvents(e){e.addEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=e}stopListenToKeyEvents(){this._domElementKeyEvents!==null&&(this._domElementKeyEvents.removeEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=null)}saveState(){this.target0.copy(this.target),this.position0.copy(this.object.position),this.zoom0=this.object.zoom}reset(){this.target.copy(this.target0),this.object.position.copy(this.position0),this.object.zoom=this.zoom0,this.object.updateProjectionMatrix(),this.dispatchEvent(ut),this.update(),this.state=x.NONE}update(e=null){const t=this.object.position;R.copy(t).sub(this.target),R.applyQuaternion(this._quat),this._spherical.setFromVector3(R),this.autoRotate&&this.state===x.NONE&&this._rotateLeft(this._getAutoRotationAngle(e)),this.enableDamping?(this._spherical.theta+=this._sphericalDelta.theta*this.dampingFactor,this._spherical.phi+=this._sphericalDelta.phi*this.dampingFactor):(this._spherical.theta+=this._sphericalDelta.theta,this._spherical.phi+=this._sphericalDelta.phi);let s=this.minAzimuthAngle,i=this.maxAzimuthAngle;isFinite(s)&&isFinite(i)&&(s<-Math.PI?s+=L:s>Math.PI&&(s-=L),i<-Math.PI?i+=L:i>Math.PI&&(i-=L),s<=i?this._spherical.theta=Math.max(s,Math.min(i,this._spherical.theta)):this._spherical.theta=this._spherical.theta>(s+i)/2?Math.max(s,this._spherical.theta):Math.min(i,this._spherical.theta)),this._spherical.phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this._spherical.phi)),this._spherical.makeSafe(),this.enableDamping===!0?this.target.addScaledVector(this._panOffset,this.dampingFactor):this.target.add(this._panOffset),this.target.sub(this.cursor),this.target.clampLength(this.minTargetRadius,this.maxTargetRadius),this.target.add(this.cursor);let n=!1;if(this.zoomToCursor&&this._performCursorZoom||this.object.isOrthographicCamera)this._spherical.radius=this._clampDistance(this._spherical.radius);else{const r=this._spherical.radius;this._spherical.radius=this._clampDistance(this._spherical.radius*this._scale),n=r!=this._spherical.radius}if(R.setFromSpherical(this._spherical),R.applyQuaternion(this._quatInverse),t.copy(this.target).add(R),this.object.lookAt(this.target),this.enableDamping===!0?(this._sphericalDelta.theta*=1-this.dampingFactor,this._sphericalDelta.phi*=1-this.dampingFactor,this._panOffset.multiplyScalar(1-this.dampingFactor)):(this._sphericalDelta.set(0,0,0),this._panOffset.set(0,0,0)),this.zoomToCursor&&this._performCursorZoom){let r=null;if(this.object.isPerspectiveCamera){const o=R.length();r=this._clampDistance(o*this._scale);const a=o-r;this.object.position.addScaledVector(this._dollyDirection,a),this.object.updateMatrixWorld(),n=!!a}else if(this.object.isOrthographicCamera){const o=new v(this._mouse.x,this._mouse.y,0);o.unproject(this.object);const a=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),this.object.updateProjectionMatrix(),n=a!==this.object.zoom;const h=new v(this._mouse.x,this._mouse.y,0);h.unproject(this.object),this.object.position.sub(h).add(o),this.object.updateMatrixWorld(),r=R.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),this.zoomToCursor=!1;r!==null&&(this.screenSpacePanning?this.target.set(0,0,-1).transformDirection(this.object.matrix).multiplyScalar(r).add(this.object.position):(Pe.origin.copy(this.object.position),Pe.direction.set(0,0,-1).transformDirection(this.object.matrix),Math.abs(this.object.up.dot(Pe.direction))<Gs?this.object.lookAt(this.target):(dt.setFromNormalAndCoplanarPoint(this.object.up,this.target),Pe.intersectPlane(dt,this.target))))}else if(this.object.isOrthographicCamera){const r=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),r!==this.object.zoom&&(this.object.updateProjectionMatrix(),n=!0)}return this._scale=1,this._performCursorZoom=!1,n||this._lastPosition.distanceToSquared(this.object.position)>He||8*(1-this._lastQuaternion.dot(this.object.quaternion))>He||this._lastTargetPosition.distanceToSquared(this.target)>He?(this.dispatchEvent(ut),this._lastPosition.copy(this.object.position),this._lastQuaternion.copy(this.object.quaternion),this._lastTargetPosition.copy(this.target),!0):!1}_getAutoRotationAngle(e){return e!==null?L/60*this.autoRotateSpeed*e:L/60/60*this.autoRotateSpeed}_getZoomScale(e){const t=Math.abs(e*.01);return Math.pow(.95,this.zoomSpeed*t)}_rotateLeft(e){this._sphericalDelta.theta-=e}_rotateUp(e){this._sphericalDelta.phi-=e}_panLeft(e,t){R.setFromMatrixColumn(t,0),R.multiplyScalar(-e),this._panOffset.add(R)}_panUp(e,t){this.screenSpacePanning===!0?R.setFromMatrixColumn(t,1):(R.setFromMatrixColumn(t,0),R.crossVectors(this.object.up,R)),R.multiplyScalar(e),this._panOffset.add(R)}_pan(e,t){const s=this.domElement;if(this.object.isPerspectiveCamera){const i=this.object.position;R.copy(i).sub(this.target);let n=R.length();n*=Math.tan(this.object.fov/2*Math.PI/180),this._panLeft(2*e*n/s.clientHeight,this.object.matrix),this._panUp(2*t*n/s.clientHeight,this.object.matrix)}else this.object.isOrthographicCamera?(this._panLeft(e*(this.object.right-this.object.left)/this.object.zoom/s.clientWidth,this.object.matrix),this._panUp(t*(this.object.top-this.object.bottom)/this.object.zoom/s.clientHeight,this.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),this.enablePan=!1)}_dollyOut(e){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale/=e:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),this.enableZoom=!1)}_dollyIn(e){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale*=e:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),this.enableZoom=!1)}_updateZoomParameters(e,t){if(!this.zoomToCursor)return;this._performCursorZoom=!0;const s=this.domElement.getBoundingClientRect(),i=e-s.left,n=t-s.top,r=s.width,o=s.height;this._mouse.x=i/r*2-1,this._mouse.y=-(n/o)*2+1,this._dollyDirection.set(this._mouse.x,this._mouse.y,1).unproject(this.object).sub(this.object.position).normalize()}_clampDistance(e){return Math.max(this.minDistance,Math.min(this.maxDistance,e))}_handleMouseDownRotate(e){this._rotateStart.set(e.clientX,e.clientY)}_handleMouseDownDolly(e){this._updateZoomParameters(e.clientX,e.clientX),this._dollyStart.set(e.clientX,e.clientY)}_handleMouseDownPan(e){this._panStart.set(e.clientX,e.clientY)}_handleMouseMoveRotate(e){this._rotateEnd.set(e.clientX,e.clientY),this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const t=this.domElement;this._rotateLeft(L*this._rotateDelta.x/t.clientHeight),this._rotateUp(L*this._rotateDelta.y/t.clientHeight),this._rotateStart.copy(this._rotateEnd),this.update()}_handleMouseMoveDolly(e){this._dollyEnd.set(e.clientX,e.clientY),this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),this._dollyDelta.y>0?this._dollyOut(this._getZoomScale(this._dollyDelta.y)):this._dollyDelta.y<0&&this._dollyIn(this._getZoomScale(this._dollyDelta.y)),this._dollyStart.copy(this._dollyEnd),this.update()}_handleMouseMovePan(e){this._panEnd.set(e.clientX,e.clientY),this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd),this.update()}_handleMouseWheel(e){this._updateZoomParameters(e.clientX,e.clientY),e.deltaY<0?this._dollyIn(this._getZoomScale(e.deltaY)):e.deltaY>0&&this._dollyOut(this._getZoomScale(e.deltaY)),this.update()}_handleKeyDown(e){let t=!1;switch(e.code){case this.keys.UP:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateUp(L*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(0,this.keyPanSpeed),t=!0;break;case this.keys.BOTTOM:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateUp(-L*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(0,-this.keyPanSpeed),t=!0;break;case this.keys.LEFT:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateLeft(L*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(this.keyPanSpeed,0),t=!0;break;case this.keys.RIGHT:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateLeft(-L*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(-this.keyPanSpeed,0),t=!0;break}t&&(e.preventDefault(),this.update())}_handleTouchStartRotate(e){if(this._pointers.length===1)this._rotateStart.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),s=.5*(e.pageX+t.x),i=.5*(e.pageY+t.y);this._rotateStart.set(s,i)}}_handleTouchStartPan(e){if(this._pointers.length===1)this._panStart.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),s=.5*(e.pageX+t.x),i=.5*(e.pageY+t.y);this._panStart.set(s,i)}}_handleTouchStartDolly(e){const t=this._getSecondPointerPosition(e),s=e.pageX-t.x,i=e.pageY-t.y,n=Math.sqrt(s*s+i*i);this._dollyStart.set(0,n)}_handleTouchStartDollyPan(e){this.enableZoom&&this._handleTouchStartDolly(e),this.enablePan&&this._handleTouchStartPan(e)}_handleTouchStartDollyRotate(e){this.enableZoom&&this._handleTouchStartDolly(e),this.enableRotate&&this._handleTouchStartRotate(e)}_handleTouchMoveRotate(e){if(this._pointers.length==1)this._rotateEnd.set(e.pageX,e.pageY);else{const s=this._getSecondPointerPosition(e),i=.5*(e.pageX+s.x),n=.5*(e.pageY+s.y);this._rotateEnd.set(i,n)}this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const t=this.domElement;this._rotateLeft(L*this._rotateDelta.x/t.clientHeight),this._rotateUp(L*this._rotateDelta.y/t.clientHeight),this._rotateStart.copy(this._rotateEnd)}_handleTouchMovePan(e){if(this._pointers.length===1)this._panEnd.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),s=.5*(e.pageX+t.x),i=.5*(e.pageY+t.y);this._panEnd.set(s,i)}this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd)}_handleTouchMoveDolly(e){const t=this._getSecondPointerPosition(e),s=e.pageX-t.x,i=e.pageY-t.y,n=Math.sqrt(s*s+i*i);this._dollyEnd.set(0,n),this._dollyDelta.set(0,Math.pow(this._dollyEnd.y/this._dollyStart.y,this.zoomSpeed)),this._dollyOut(this._dollyDelta.y),this._dollyStart.copy(this._dollyEnd);const r=(e.pageX+t.x)*.5,o=(e.pageY+t.y)*.5;this._updateZoomParameters(r,o)}_handleTouchMoveDollyPan(e){this.enableZoom&&this._handleTouchMoveDolly(e),this.enablePan&&this._handleTouchMovePan(e)}_handleTouchMoveDollyRotate(e){this.enableZoom&&this._handleTouchMoveDolly(e),this.enableRotate&&this._handleTouchMoveRotate(e)}_addPointer(e){this._pointers.push(e.pointerId)}_removePointer(e){delete this._pointerPositions[e.pointerId];for(let t=0;t<this._pointers.length;t++)if(this._pointers[t]==e.pointerId){this._pointers.splice(t,1);return}}_isTrackingPointer(e){for(let t=0;t<this._pointers.length;t++)if(this._pointers[t]==e.pointerId)return!0;return!1}_trackPointer(e){let t=this._pointerPositions[e.pointerId];t===void 0&&(t=new C,this._pointerPositions[e.pointerId]=t),t.set(e.pageX,e.pageY)}_getSecondPointerPosition(e){const t=e.pointerId===this._pointers[0]?this._pointers[1]:this._pointers[0];return this._pointerPositions[t]}_customWheelEvent(e){const t=e.deltaMode,s={clientX:e.clientX,clientY:e.clientY,deltaY:e.deltaY};switch(t){case 1:s.deltaY*=16;break;case 2:s.deltaY*=100;break}return e.ctrlKey&&!this._controlActive&&(s.deltaY*=10),s}}function Ks(c){this.enabled!==!1&&(this._pointers.length===0&&(this.domElement.setPointerCapture(c.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.domElement.addEventListener("pointerup",this._onPointerUp)),!this._isTrackingPointer(c)&&(this._addPointer(c),c.pointerType==="touch"?this._onTouchStart(c):this._onMouseDown(c)))}function Bs(c){this.enabled!==!1&&(c.pointerType==="touch"?this._onTouchMove(c):this._onMouseMove(c))}function zs(c){switch(this._removePointer(c),this._pointers.length){case 0:this.domElement.releasePointerCapture(c.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.dispatchEvent(Dt),this.state=x.NONE;break;case 1:const e=this._pointers[0],t=this._pointerPositions[e];this._onTouchStart({pointerId:e,pageX:t.x,pageY:t.y});break}}function Ys(c){let e;switch(c.button){case 0:e=this.mouseButtons.LEFT;break;case 1:e=this.mouseButtons.MIDDLE;break;case 2:e=this.mouseButtons.RIGHT;break;default:e=-1}switch(e){case k.DOLLY:if(this.enableZoom===!1)return;this._handleMouseDownDolly(c),this.state=x.DOLLY;break;case k.ROTATE:if(c.ctrlKey||c.metaKey||c.shiftKey){if(this.enablePan===!1)return;this._handleMouseDownPan(c),this.state=x.PAN}else{if(this.enableRotate===!1)return;this._handleMouseDownRotate(c),this.state=x.ROTATE}break;case k.PAN:if(c.ctrlKey||c.metaKey||c.shiftKey){if(this.enableRotate===!1)return;this._handleMouseDownRotate(c),this.state=x.ROTATE}else{if(this.enablePan===!1)return;this._handleMouseDownPan(c),this.state=x.PAN}break;default:this.state=x.NONE}this.state!==x.NONE&&this.dispatchEvent(st)}function Xs(c){switch(this.state){case x.ROTATE:if(this.enableRotate===!1)return;this._handleMouseMoveRotate(c);break;case x.DOLLY:if(this.enableZoom===!1)return;this._handleMouseMoveDolly(c);break;case x.PAN:if(this.enablePan===!1)return;this._handleMouseMovePan(c);break}}function Vs(c){this.enabled===!1||this.enableZoom===!1||this.state!==x.NONE||(c.preventDefault(),this.dispatchEvent(st),this._handleMouseWheel(this._customWheelEvent(c)),this.dispatchEvent(Dt))}function Ws(c){this.enabled!==!1&&this._handleKeyDown(c)}function qs(c){switch(this._trackPointer(c),this._pointers.length){case 1:switch(this.touches.ONE){case G.ROTATE:if(this.enableRotate===!1)return;this._handleTouchStartRotate(c),this.state=x.TOUCH_ROTATE;break;case G.PAN:if(this.enablePan===!1)return;this._handleTouchStartPan(c),this.state=x.TOUCH_PAN;break;default:this.state=x.NONE}break;case 2:switch(this.touches.TWO){case G.DOLLY_PAN:if(this.enableZoom===!1&&this.enablePan===!1)return;this._handleTouchStartDollyPan(c),this.state=x.TOUCH_DOLLY_PAN;break;case G.DOLLY_ROTATE:if(this.enableZoom===!1&&this.enableRotate===!1)return;this._handleTouchStartDollyRotate(c),this.state=x.TOUCH_DOLLY_ROTATE;break;default:this.state=x.NONE}break;default:this.state=x.NONE}this.state!==x.NONE&&this.dispatchEvent(st)}function Zs(c){switch(this._trackPointer(c),this.state){case x.TOUCH_ROTATE:if(this.enableRotate===!1)return;this._handleTouchMoveRotate(c),this.update();break;case x.TOUCH_PAN:if(this.enablePan===!1)return;this._handleTouchMovePan(c),this.update();break;case x.TOUCH_DOLLY_PAN:if(this.enableZoom===!1&&this.enablePan===!1)return;this._handleTouchMoveDollyPan(c),this.update();break;case x.TOUCH_DOLLY_ROTATE:if(this.enableZoom===!1&&this.enableRotate===!1)return;this._handleTouchMoveDollyRotate(c),this.update();break;default:this.state=x.NONE}}function Qs(c){this.enabled!==!1&&c.preventDefault()}function $s(c){c.key==="Control"&&(this._controlActive=!0,this.domElement.getRootNode().addEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0}))}function Js(c){c.key==="Control"&&(this._controlActive=!1,this.domElement.getRootNode().removeEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0}))}class ei extends Us{constructor(e,t){super(e,t),this.screenSpacePanning=!1,this.mouseButtons={LEFT:k.PAN,MIDDLE:k.DOLLY,RIGHT:k.ROTATE},this.touches={ONE:G.PAN,TWO:G.DOLLY_ROTATE}}}const N=new Qt(0,0,0,"YXZ"),le=new v,ti={type:"change"},si={type:"lock"},ii={type:"unlock"},Oe=Math.PI/2;class ni extends et{constructor(t,s=null){super(t,s);m(this,"attachedCamera",null);this.isLocked=!1,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.pointerSpeed=1,this._onMouseMove=ri.bind(this),this._onPointerlockChange=oi.bind(this),this._onPointerlockError=ai.bind(this),this.domElement!==null&&this.connect()}connect(){this.domElement.ownerDocument.addEventListener("mousemove",this._onMouseMove),this.domElement.ownerDocument.addEventListener("pointerlockchange",this._onPointerlockChange),this.domElement.ownerDocument.addEventListener("pointerlockerror",this._onPointerlockError)}disconnect(){this.domElement.ownerDocument.removeEventListener("mousemove",this._onMouseMove),this.domElement.ownerDocument.removeEventListener("pointerlockchange",this._onPointerlockChange),this.domElement.ownerDocument.removeEventListener("pointerlockerror",this._onPointerlockError)}dispose(){this.disconnect()}getObject(){return console.warn("THREE.PointerLockControls: getObject() has been deprecated. Use controls.object instead."),this.object}getDirection(t){return t.set(0,0,-1).applyQuaternion(this.object.quaternion)}moveForward(t){if(this.enabled===!1)return;const s=this.object;le.setFromMatrixColumn(s.matrix,0),le.crossVectors(s.up,le),s.position.addScaledVector(le,t)}moveRight(t){if(this.enabled===!1)return;const s=this.object;le.setFromMatrixColumn(s.matrix,0),s.position.addScaledVector(le,t)}lock(){this.domElement.requestPointerLock()}unlock(){this.domElement.ownerDocument.exitPointerLock()}attachCamera(t){this.attachedCamera=t}detachCamera(){this.attachedCamera=null}}function ri(c){if(this.enabled===!1||this.isLocked===!1)return;const e=c.movementX||c.mozMovementX||c.webkitMovementX||0,t=c.movementY||c.mozMovementY||c.webkitMovementY||0,s=this.object;N.setFromQuaternion(s.quaternion),N.y-=e*.002*this.pointerSpeed,N.x-=t*.002*this.pointerSpeed,N.x=Math.max(Oe-this.maxPolarAngle,Math.min(Oe-this.minPolarAngle,N.x)),s.quaternion.setFromEuler(N),this.attachedCamera!=null&&(N.setFromQuaternion(this.attachedCamera.quaternion),N.y-=e*.002*this.pointerSpeed,N.x-=t*.002*this.pointerSpeed,N.x=Math.max(Oe-this.maxPolarAngle,Math.min(Oe-this.minPolarAngle,N.x)),this.attachedCamera.quaternion.setFromEuler(N)),this.dispatchEvent({...ti},"")}function oi(){this.domElement.ownerDocument.pointerLockElement===this.domElement?(this.dispatchEvent(si),this.isLocked=!0):(this.dispatchEvent(ii),this.isLocked=!1)}function ai(){console.error("THREE.PointerLockControls: Unable to use Pointer Lock API")}const ue=new Je,V=new C,It=new v,Ge=new C,Le=new C,ke=new v,Ze=new v,Nt=new J,Ft=new v,Ht=new v;let j=null,z=null;const W=[],ee={NONE:-1,PAN:0,ROTATE:1};class ci extends et{constructor(e,t,s=null){super(t,s),this.objects=e,this.recursive=!0,this.transformGroup=!1,this.rotateSpeed=1,this.raycaster=new ze,this.mouseButtons={LEFT:k.PAN,MIDDLE:k.PAN,RIGHT:k.ROTATE},this.touches={ONE:G.PAN},this._onPointerMove=hi.bind(this),this._onPointerDown=li.bind(this),this._onPointerCancel=ui.bind(this),this._onContextMenu=di.bind(this),s!==null&&this.connect()}connect(){this.domElement.addEventListener("pointermove",this._onPointerMove),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointerup",this._onPointerCancel),this.domElement.addEventListener("pointerleave",this._onPointerCancel),this.domElement.addEventListener("contextmenu",this._onContextMenu),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointerup",this._onPointerCancel),this.domElement.removeEventListener("pointerleave",this._onPointerCancel),this.domElement.removeEventListener("contextmenu",this._onContextMenu),this.domElement.style.touchAction="auto",this.domElement.style.cursor=""}dispose(){this.disconnect()}_updatePointer(e){const t=this.domElement.getBoundingClientRect();V.x=(e.clientX-t.left)/t.width*2-1,V.y=-(e.clientY-t.top)/t.height*2+1}_updateState(e){let t;if(e.pointerType==="touch")t=this.touches.ONE;else switch(e.button){case 0:t=this.mouseButtons.LEFT;break;case 1:t=this.mouseButtons.MIDDLE;break;case 2:t=this.mouseButtons.RIGHT;break;default:t=null}switch(t){case k.PAN:case G.PAN:this.state=ee.PAN;break;case k.ROTATE:case G.ROTATE:this.state=ee.ROTATE;break;default:this.state=ee.NONE}}getRaycaster(){return console.warn("THREE.DragControls: getRaycaster() has been deprecated. Use controls.raycaster instead."),this.raycaster}setObjects(e){console.warn("THREE.DragControls: setObjects() has been deprecated. Use controls.objects instead."),this.objects=e}getObjects(){return console.warn("THREE.DragControls: getObjects() has been deprecated. Use controls.objects instead."),this.objects}activate(){console.warn("THREE.DragControls: activate() has been renamed to connect()."),this.connect()}deactivate(){console.warn("THREE.DragControls: deactivate() has been renamed to disconnect()."),this.disconnect()}set mode(e){console.warn("THREE.DragControls: The .mode property has been removed. Define the type of transformation via the .mouseButtons or .touches properties.")}get mode(){console.warn("THREE.DragControls: The .mode property has been removed. Define the type of transformation via the .mouseButtons or .touches properties.")}}function hi(c){const e=this.object,t=this.domElement,s=this.raycaster;if(this.enabled!==!1){if(this._updatePointer(c),s.setFromCamera(V,e),j)this.state===ee.PAN?s.ray.intersectPlane(ue,ke)&&j.position.copy(ke.sub(It).applyMatrix4(Nt)):this.state===ee.ROTATE&&(Ge.subVectors(V,Le).multiplyScalar(this.rotateSpeed),j.rotateOnWorldAxis(Ft,Ge.x),j.rotateOnWorldAxis(Ht.normalize(),-Ge.y)),this.dispatchEvent({type:"drag",object:j}),Le.copy(V);else if(c.pointerType==="mouse"||c.pointerType==="pen")if(W.length=0,s.setFromCamera(V,e),s.intersectObjects(this.objects,this.recursive,W),W.length>0){const i=W[0].object;ue.setFromNormalAndCoplanarPoint(e.getWorldDirection(ue.normal),Ze.setFromMatrixPosition(i.matrixWorld)),z!==i&&z!==null&&(this.dispatchEvent({type:"hoveroff",object:z}),t.style.cursor="auto",z=null),z!==i&&(this.dispatchEvent({type:"hoveron",object:i}),t.style.cursor="pointer",z=i)}else z!==null&&(this.dispatchEvent({type:"hoveroff",object:z}),t.style.cursor="auto",z=null);Le.copy(V)}}function li(c){const e=this.object,t=this.domElement,s=this.raycaster;this.enabled!==!1&&(this._updatePointer(c),this._updateState(c),W.length=0,s.setFromCamera(V,e),s.intersectObjects(this.objects,this.recursive,W),W.length>0&&(this.transformGroup===!0?j=Gt(W[0].object):j=W[0].object,ue.setFromNormalAndCoplanarPoint(e.getWorldDirection(ue.normal),Ze.setFromMatrixPosition(j.matrixWorld)),s.ray.intersectPlane(ue,ke)&&(this.state===ee.PAN?(Nt.copy(j.parent.matrixWorld).invert(),It.copy(ke).sub(Ze.setFromMatrixPosition(j.matrixWorld))):this.state===ee.ROTATE&&(Ft.set(0,1,0).applyQuaternion(e.quaternion).normalize(),Ht.set(1,0,0).applyQuaternion(e.quaternion).normalize())),t.style.cursor="move",this.dispatchEvent({type:"dragstart",object:j})),Le.copy(V))}function ui(){this.enabled!==!1&&(j&&(this.dispatchEvent({type:"dragend",object:j}),j=null),this.domElement.style.cursor=z?"pointer":"auto",this.state=ee.NONE)}function di(c){this.enabled!==!1&&c.preventDefault()}function Gt(c,e=null){return c.isGroup&&(e=c),c.parent===null?e:Gt(c.parent,e)}function pt(c,e){if(e===$t)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),c;if(e===Ye||e===vt){let t=c.getIndex();if(t===null){const r=[],o=c.getAttribute("position");if(o!==void 0){for(let a=0;a<o.count;a++)r.push(a);c.setIndex(r),t=c.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),c}const s=t.count-2,i=[];if(e===Ye)for(let r=1;r<=s;r++)i.push(t.getX(0)),i.push(t.getX(r)),i.push(t.getX(r+1));else for(let r=0;r<s;r++)r%2===0?(i.push(t.getX(r)),i.push(t.getX(r+1)),i.push(t.getX(r+2))):(i.push(t.getX(r+2)),i.push(t.getX(r+1)),i.push(t.getX(r)));i.length/3!==s&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const n=c.clone();return n.setIndex(i),n.clearGroups(),n}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),c}class pi extends Jt{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(t){return new bi(t)}),this.register(function(t){return new Ai(t)}),this.register(function(t){return new Ri(t)}),this.register(function(t){return new Pi(t)}),this.register(function(t){return new Oi(t)}),this.register(function(t){return new _i(t)}),this.register(function(t){return new Ei(t)}),this.register(function(t){return new vi(t)}),this.register(function(t){return new xi(t)}),this.register(function(t){return new yi(t)}),this.register(function(t){return new wi(t)}),this.register(function(t){return new Ti(t)}),this.register(function(t){return new Ci(t)}),this.register(function(t){return new Mi(t)}),this.register(function(t){return new mi(t)}),this.register(function(t){return new Si(t)}),this.register(function(t){return new Li(t)})}load(e,t,s,i){const n=this;let r;if(this.resourcePath!=="")r=this.resourcePath;else if(this.path!==""){const h=Ee.extractUrlBase(e);r=Ee.resolveURL(h,this.path)}else r=Ee.extractUrlBase(e);this.manager.itemStart(e);const o=function(h){i?i(h):console.error(h),n.manager.itemError(e),n.manager.itemEnd(e)},a=new xt(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(e,function(h){try{n.parse(h,r,function(l){t(l),n.manager.itemEnd(e)},o)}catch(l){o(l)}},s,o)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,i){let n;const r={},o={},a=new TextDecoder;if(typeof e=="string")n=JSON.parse(e);else if(e instanceof ArrayBuffer)if(a.decode(new Uint8Array(e,0,4))===Ut){try{r[T.KHR_BINARY_GLTF]=new ji(e)}catch(u){i&&i(u);return}n=JSON.parse(r[T.KHR_BINARY_GLTF].content)}else n=JSON.parse(a.decode(e));else n=e;if(n.asset===void 0||n.asset.version[0]<2){i&&i(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const h=new Xi(n,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});h.fileLoader.setRequestHeader(this.requestHeader);for(let l=0;l<this.pluginCallbacks.length;l++){const u=this.pluginCallbacks[l](h);u.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),o[u.name]=u,r[u.name]=!0}if(n.extensionsUsed)for(let l=0;l<n.extensionsUsed.length;++l){const u=n.extensionsUsed[l],d=n.extensionsRequired||[];switch(u){case T.KHR_MATERIALS_UNLIT:r[u]=new gi;break;case T.KHR_DRACO_MESH_COMPRESSION:r[u]=new ki(n,this.dracoLoader);break;case T.KHR_TEXTURE_TRANSFORM:r[u]=new Di;break;case T.KHR_MESH_QUANTIZATION:r[u]=new Ii;break;default:d.indexOf(u)>=0&&o[u]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+u+'".')}}h.setExtensions(r),h.setPlugins(o),h.parse(s,i)}parseAsync(e,t){const s=this;return new Promise(function(i,n){s.parse(e,t,i,n)})}}function fi(){let c={};return{get:function(e){return c[e]},add:function(e,t){c[e]=t},remove:function(e){delete c[e]},removeAll:function(){c={}}}}const T={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class mi{constructor(e){this.parser=e,this.name=T.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let s=0,i=t.length;s<i;s++){const n=t[s];n.extensions&&n.extensions[this.name]&&n.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,n.extensions[this.name].light)}}_loadLight(e){const t=this.parser,s="light:"+e;let i=t.cache.get(s);if(i)return i;const n=t.json,a=((n.extensions&&n.extensions[this.name]||{}).lights||[])[e];let h;const l=new te(16777215);a.color!==void 0&&l.setRGB(a.color[0],a.color[1],a.color[2],q);const u=a.range!==void 0?a.range:0;switch(a.type){case"directional":h=new Xe(l),h.target.position.set(0,0,-1),h.add(h.target);break;case"point":h=new ts(l),h.distance=u;break;case"spot":h=new es(l),h.distance=u,a.spot=a.spot||{},a.spot.innerConeAngle=a.spot.innerConeAngle!==void 0?a.spot.innerConeAngle:0,a.spot.outerConeAngle=a.spot.outerConeAngle!==void 0?a.spot.outerConeAngle:Math.PI/4,h.angle=a.spot.outerConeAngle,h.penumbra=1-a.spot.innerConeAngle/a.spot.outerConeAngle,h.target.position.set(0,0,-1),h.add(h.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+a.type)}return h.position.set(0,0,0),h.decay=2,X(h,a),a.intensity!==void 0&&(h.intensity=a.intensity),h.name=t.createUniqueName(a.name||"light_"+e),i=Promise.resolve(h),t.cache.add(s,i),i}getDependency(e,t){if(e==="light")return this._loadLight(t)}createNodeAttachment(e){const t=this,s=this.parser,n=s.json.nodes[e],o=(n.extensions&&n.extensions[this.name]||{}).light;return o===void 0?null:this._loadLight(o).then(function(a){return s._getNodeRef(t.cache,o,a)})}}class gi{constructor(){this.name=T.KHR_MATERIALS_UNLIT}getMaterialType(){return oe}extendParams(e,t,s){const i=[];e.color=new te(1,1,1),e.opacity=1;const n=t.pbrMetallicRoughness;if(n){if(Array.isArray(n.baseColorFactor)){const r=n.baseColorFactor;e.color.setRGB(r[0],r[1],r[2],q),e.opacity=r[3]}n.baseColorTexture!==void 0&&i.push(s.assignTexture(e,"map",n.baseColorTexture,ve))}return Promise.all(i)}}class yi{constructor(e){this.parser=e,this.name=T.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=i.extensions[this.name].emissiveStrength;return n!==void 0&&(t.emissiveIntensity=n),Promise.resolve()}}class bi{constructor(e){this.parser=e,this.name=T.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:K}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],r=i.extensions[this.name];if(r.clearcoatFactor!==void 0&&(t.clearcoat=r.clearcoatFactor),r.clearcoatTexture!==void 0&&n.push(s.assignTexture(t,"clearcoatMap",r.clearcoatTexture)),r.clearcoatRoughnessFactor!==void 0&&(t.clearcoatRoughness=r.clearcoatRoughnessFactor),r.clearcoatRoughnessTexture!==void 0&&n.push(s.assignTexture(t,"clearcoatRoughnessMap",r.clearcoatRoughnessTexture)),r.clearcoatNormalTexture!==void 0&&(n.push(s.assignTexture(t,"clearcoatNormalMap",r.clearcoatNormalTexture)),r.clearcoatNormalTexture.scale!==void 0)){const o=r.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new C(o,o)}return Promise.all(n)}}class Ai{constructor(e){this.parser=e,this.name=T.KHR_MATERIALS_DISPERSION}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:K}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=i.extensions[this.name];return t.dispersion=n.dispersion!==void 0?n.dispersion:0,Promise.resolve()}}class Ti{constructor(e){this.parser=e,this.name=T.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:K}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],r=i.extensions[this.name];return r.iridescenceFactor!==void 0&&(t.iridescence=r.iridescenceFactor),r.iridescenceTexture!==void 0&&n.push(s.assignTexture(t,"iridescenceMap",r.iridescenceTexture)),r.iridescenceIor!==void 0&&(t.iridescenceIOR=r.iridescenceIor),t.iridescenceThicknessRange===void 0&&(t.iridescenceThicknessRange=[100,400]),r.iridescenceThicknessMinimum!==void 0&&(t.iridescenceThicknessRange[0]=r.iridescenceThicknessMinimum),r.iridescenceThicknessMaximum!==void 0&&(t.iridescenceThicknessRange[1]=r.iridescenceThicknessMaximum),r.iridescenceThicknessTexture!==void 0&&n.push(s.assignTexture(t,"iridescenceThicknessMap",r.iridescenceThicknessTexture)),Promise.all(n)}}class _i{constructor(e){this.parser=e,this.name=T.KHR_MATERIALS_SHEEN}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:K}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[];t.sheenColor=new te(0,0,0),t.sheenRoughness=0,t.sheen=1;const r=i.extensions[this.name];if(r.sheenColorFactor!==void 0){const o=r.sheenColorFactor;t.sheenColor.setRGB(o[0],o[1],o[2],q)}return r.sheenRoughnessFactor!==void 0&&(t.sheenRoughness=r.sheenRoughnessFactor),r.sheenColorTexture!==void 0&&n.push(s.assignTexture(t,"sheenColorMap",r.sheenColorTexture,ve)),r.sheenRoughnessTexture!==void 0&&n.push(s.assignTexture(t,"sheenRoughnessMap",r.sheenRoughnessTexture)),Promise.all(n)}}class Ei{constructor(e){this.parser=e,this.name=T.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:K}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],r=i.extensions[this.name];return r.transmissionFactor!==void 0&&(t.transmission=r.transmissionFactor),r.transmissionTexture!==void 0&&n.push(s.assignTexture(t,"transmissionMap",r.transmissionTexture)),Promise.all(n)}}class vi{constructor(e){this.parser=e,this.name=T.KHR_MATERIALS_VOLUME}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:K}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],r=i.extensions[this.name];t.thickness=r.thicknessFactor!==void 0?r.thicknessFactor:0,r.thicknessTexture!==void 0&&n.push(s.assignTexture(t,"thicknessMap",r.thicknessTexture)),t.attenuationDistance=r.attenuationDistance||1/0;const o=r.attenuationColor||[1,1,1];return t.attenuationColor=new te().setRGB(o[0],o[1],o[2],q),Promise.all(n)}}class xi{constructor(e){this.parser=e,this.name=T.KHR_MATERIALS_IOR}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:K}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=i.extensions[this.name];return t.ior=n.ior!==void 0?n.ior:1.5,Promise.resolve()}}class wi{constructor(e){this.parser=e,this.name=T.KHR_MATERIALS_SPECULAR}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:K}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],r=i.extensions[this.name];t.specularIntensity=r.specularFactor!==void 0?r.specularFactor:1,r.specularTexture!==void 0&&n.push(s.assignTexture(t,"specularIntensityMap",r.specularTexture));const o=r.specularColorFactor||[1,1,1];return t.specularColor=new te().setRGB(o[0],o[1],o[2],q),r.specularColorTexture!==void 0&&n.push(s.assignTexture(t,"specularColorMap",r.specularColorTexture,ve)),Promise.all(n)}}class Mi{constructor(e){this.parser=e,this.name=T.EXT_MATERIALS_BUMP}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:K}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],r=i.extensions[this.name];return t.bumpScale=r.bumpFactor!==void 0?r.bumpFactor:1,r.bumpTexture!==void 0&&n.push(s.assignTexture(t,"bumpMap",r.bumpTexture)),Promise.all(n)}}class Ci{constructor(e){this.parser=e,this.name=T.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:K}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],r=i.extensions[this.name];return r.anisotropyStrength!==void 0&&(t.anisotropy=r.anisotropyStrength),r.anisotropyRotation!==void 0&&(t.anisotropyRotation=r.anisotropyRotation),r.anisotropyTexture!==void 0&&n.push(s.assignTexture(t,"anisotropyMap",r.anisotropyTexture)),Promise.all(n)}}class Ri{constructor(e){this.parser=e,this.name=T.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,s=t.json,i=s.textures[e];if(!i.extensions||!i.extensions[this.name])return null;const n=i.extensions[this.name],r=t.options.ktx2Loader;if(!r){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,n.source,r)}}class Pi{constructor(e){this.parser=e,this.name=T.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,i=s.json,n=i.textures[e];if(!n.extensions||!n.extensions[t])return null;const r=n.extensions[t],o=i.images[r.source];let a=s.textureLoader;if(o.uri){const h=s.options.manager.getHandler(o.uri);h!==null&&(a=h)}return this.detectSupport().then(function(h){if(h)return s.loadTextureImage(e,r.source,a);if(i.extensionsRequired&&i.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class Oi{constructor(e){this.parser=e,this.name=T.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,i=s.json,n=i.textures[e];if(!n.extensions||!n.extensions[t])return null;const r=n.extensions[t],o=i.images[r.source];let a=s.textureLoader;if(o.uri){const h=s.options.manager.getHandler(o.uri);h!==null&&(a=h)}return this.detectSupport().then(function(h){if(h)return s.loadTextureImage(e,r.source,a);if(i.extensionsRequired&&i.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class Si{constructor(e){this.name=T.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,s=t.bufferViews[e];if(s.extensions&&s.extensions[this.name]){const i=s.extensions[this.name],n=this.parser.getDependency("buffer",i.buffer),r=this.parser.options.meshoptDecoder;if(!r||!r.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return n.then(function(o){const a=i.byteOffset||0,h=i.byteLength||0,l=i.count,u=i.byteStride,d=new Uint8Array(o,a,h);return r.decodeGltfBufferAsync?r.decodeGltfBufferAsync(l,u,d,i.mode,i.filter).then(function(p){return p.buffer}):r.ready.then(function(){const p=new ArrayBuffer(l*u);return r.decodeGltfBuffer(new Uint8Array(p),l,u,d,i.mode,i.filter),p})})}else return null}}class Li{constructor(e){this.name=T.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,s=t.nodes[e];if(!s.extensions||!s.extensions[this.name]||s.mesh===void 0)return null;const i=t.meshes[s.mesh];for(const h of i.primitives)if(h.mode!==F.TRIANGLES&&h.mode!==F.TRIANGLE_STRIP&&h.mode!==F.TRIANGLE_FAN&&h.mode!==void 0)return null;const r=s.extensions[this.name].attributes,o=[],a={};for(const h in r)o.push(this.parser.getDependency("accessor",r[h]).then(l=>(a[h]=l,a[h])));return o.length<1?null:(o.push(this.parser.createNodeMesh(e)),Promise.all(o).then(h=>{const l=h.pop(),u=l.isGroup?l.children:[l],d=h[0].count,p=[];for(const f of u){const b=new J,g=new v,A=new ge,E=new v(1,1,1),w=new ss(f.geometry,f.material,d);for(let _=0;_<d;_++)a.TRANSLATION&&g.fromBufferAttribute(a.TRANSLATION,_),a.ROTATION&&A.fromBufferAttribute(a.ROTATION,_),a.SCALE&&E.fromBufferAttribute(a.SCALE,_),w.setMatrixAt(_,b.compose(g,A,E));for(const _ in a)if(_==="_COLOR_0"){const B=a[_];w.instanceColor=new is(B.array,B.itemSize,B.normalized)}else _!=="TRANSLATION"&&_!=="ROTATION"&&_!=="SCALE"&&f.geometry.setAttribute(_,a[_]);wt.prototype.copy.call(w,f),this.parser.assignFinalMaterial(w),p.push(w)}return l.isGroup?(l.clear(),l.add(...p),l):p[0]}))}}const Ut="glTF",Ae=12,ft={JSON:1313821514,BIN:5130562};class ji{constructor(e){this.name=T.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,Ae),s=new TextDecoder;if(this.header={magic:s.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Ut)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const i=this.header.length-Ae,n=new DataView(e,Ae);let r=0;for(;r<i;){const o=n.getUint32(r,!0);r+=4;const a=n.getUint32(r,!0);if(r+=4,a===ft.JSON){const h=new Uint8Array(e,Ae+r,o);this.content=s.decode(h)}else if(a===ft.BIN){const h=Ae+r;this.body=e.slice(h,h+o)}r+=o}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class ki{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=T.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const s=this.json,i=this.dracoLoader,n=e.extensions[this.name].bufferView,r=e.extensions[this.name].attributes,o={},a={},h={};for(const l in r){const u=Qe[l]||l.toLowerCase();o[u]=r[l]}for(const l in e.attributes){const u=Qe[l]||l.toLowerCase();if(r[l]!==void 0){const d=s.accessors[e.attributes[l]],p=de[d.componentType];h[u]=p.name,a[u]=d.normalized===!0}}return t.getDependency("bufferView",n).then(function(l){return new Promise(function(u,d){i.decodeDracoFile(l,function(p){for(const f in p.attributes){const b=p.attributes[f],g=a[f];g!==void 0&&(b.normalized=g)}u(p)},o,h,q,d)})})}}class Di{constructor(){this.name=T.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(t.texCoord===void 0||t.texCoord===e.channel)&&t.offset===void 0&&t.rotation===void 0&&t.scale===void 0||(e=e.clone(),t.texCoord!==void 0&&(e.channel=t.texCoord),t.offset!==void 0&&e.offset.fromArray(t.offset),t.rotation!==void 0&&(e.rotation=t.rotation),t.scale!==void 0&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class Ii{constructor(){this.name=T.KHR_MESH_QUANTIZATION}}class Kt extends ws{constructor(e,t,s,i){super(e,t,s,i)}copySampleValue_(e){const t=this.resultBuffer,s=this.sampleValues,i=this.valueSize,n=e*i*3+i;for(let r=0;r!==i;r++)t[r]=s[n+r];return t}interpolate_(e,t,s,i){const n=this.resultBuffer,r=this.sampleValues,o=this.valueSize,a=o*2,h=o*3,l=i-t,u=(s-t)/l,d=u*u,p=d*u,f=e*h,b=f-h,g=-2*p+3*d,A=p-d,E=1-g,w=A-d+u;for(let _=0;_!==o;_++){const B=r[b+_+o],Z=r[b+_+a]*l,H=r[f+_+o],be=r[f+_]*l;n[_]=E*B+w*Z+g*H+A*be}return n}}const Ni=new ge;class Fi extends Kt{interpolate_(e,t,s,i){const n=super.interpolate_(e,t,s,i);return Ni.fromArray(n).normalize().toArray(n),n}}const F={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},de={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},mt={9728:je,9729:Ve,9984:gs,9985:ys,9986:bs,9987:Ct},gt={33071:As,33648:Ts,10497:We},Ue={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Qe={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},$={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Hi={CUBICSPLINE:void 0,LINEAR:jt,STEP:_s},Ke={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function Gi(c){return c.DefaultMaterial===void 0&&(c.DefaultMaterial=new Pt({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:Es})),c.DefaultMaterial}function se(c,e,t){for(const s in t.extensions)c[s]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[s]=t.extensions[s])}function X(c,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(c.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function Ui(c,e,t){let s=!1,i=!1,n=!1;for(let h=0,l=e.length;h<l;h++){const u=e[h];if(u.POSITION!==void 0&&(s=!0),u.NORMAL!==void 0&&(i=!0),u.COLOR_0!==void 0&&(n=!0),s&&i&&n)break}if(!s&&!i&&!n)return Promise.resolve(c);const r=[],o=[],a=[];for(let h=0,l=e.length;h<l;h++){const u=e[h];if(s){const d=u.POSITION!==void 0?t.getDependency("accessor",u.POSITION):c.attributes.position;r.push(d)}if(i){const d=u.NORMAL!==void 0?t.getDependency("accessor",u.NORMAL):c.attributes.normal;o.push(d)}if(n){const d=u.COLOR_0!==void 0?t.getDependency("accessor",u.COLOR_0):c.attributes.color;a.push(d)}}return Promise.all([Promise.all(r),Promise.all(o),Promise.all(a)]).then(function(h){const l=h[0],u=h[1],d=h[2];return s&&(c.morphAttributes.position=l),i&&(c.morphAttributes.normal=u),n&&(c.morphAttributes.color=d),c.morphTargetsRelative=!0,c})}function Ki(c,e){if(c.updateMorphTargets(),e.weights!==void 0)for(let t=0,s=e.weights.length;t<s;t++)c.morphTargetInfluences[t]=e.weights[t];if(e.extras&&Array.isArray(e.extras.targetNames)){const t=e.extras.targetNames;if(c.morphTargetInfluences.length===t.length){c.morphTargetDictionary={};for(let s=0,i=t.length;s<i;s++)c.morphTargetDictionary[t[s]]=s}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function Bi(c){let e;const t=c.extensions&&c.extensions[T.KHR_DRACO_MESH_COMPRESSION];if(t?e="draco:"+t.bufferView+":"+t.indices+":"+Be(t.attributes):e=c.indices+":"+Be(c.attributes)+":"+c.mode,c.targets!==void 0)for(let s=0,i=c.targets.length;s<i;s++)e+=":"+Be(c.targets[s]);return e}function Be(c){let e="";const t=Object.keys(c).sort();for(let s=0,i=t.length;s<i;s++)e+=t[s]+":"+c[t[s]]+";";return e}function $e(c){switch(c){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function zi(c){return c.search(/\.jpe?g($|\?)/i)>0||c.search(/^data\:image\/jpeg/)===0?"image/jpeg":c.search(/\.webp($|\?)/i)>0||c.search(/^data\:image\/webp/)===0?"image/webp":c.search(/\.ktx2($|\?)/i)>0||c.search(/^data\:image\/ktx2/)===0?"image/ktx2":"image/png"}const Yi=new J;class Xi{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new fi,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let s=!1,i=-1,n=!1,r=-1;if(typeof navigator<"u"){const o=navigator.userAgent;s=/^((?!chrome|android).)*safari/i.test(o)===!0;const a=o.match(/Version\/(\d+)/);i=s&&a?parseInt(a[1],10):-1,n=o.indexOf("Firefox")>-1,r=n?o.match(/Firefox\/([0-9]+)\./)[1]:-1}typeof createImageBitmap>"u"||s&&i<17||n&&r<98?this.textureLoader=new Mt(this.options.manager):this.textureLoader=new ns(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new xt(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const s=this,i=this.json,n=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(r){return r._markDefs&&r._markDefs()}),Promise.all(this._invokeAll(function(r){return r.beforeRoot&&r.beforeRoot()})).then(function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])}).then(function(r){const o={scene:r[0][i.scene||0],scenes:r[0],animations:r[1],cameras:r[2],asset:i.asset,parser:s,userData:{}};return se(n,o,i),X(o,i),Promise.all(s._invokeAll(function(a){return a.afterRoot&&a.afterRoot(o)})).then(function(){for(const a of o.scenes)a.updateMatrixWorld();e(o)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[];for(let i=0,n=t.length;i<n;i++){const r=t[i].joints;for(let o=0,a=r.length;o<a;o++)e[r[o]].isBone=!0}for(let i=0,n=e.length;i<n;i++){const r=e[i];r.mesh!==void 0&&(this._addNodeRef(this.meshCache,r.mesh),r.skin!==void 0&&(s[r.mesh].isSkinnedMesh=!0)),r.camera!==void 0&&this._addNodeRef(this.cameraCache,r.camera)}}_addNodeRef(e,t){t!==void 0&&(e.refs[t]===void 0&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,s){if(e.refs[t]<=1)return s;const i=s.clone(),n=(r,o)=>{const a=this.associations.get(r);a!=null&&this.associations.set(o,a);for(const[h,l]of r.children.entries())n(l,o.children[h])};return n(s,i),i.name+="_instance_"+e.uses[t]++,i}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){const i=e(t[s]);if(i)return i}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const s=[];for(let i=0;i<t.length;i++){const n=e(t[i]);n&&s.push(n)}return s}getDependency(e,t){const s=e+":"+t;let i=this.cache.get(s);if(!i){switch(e){case"scene":i=this.loadScene(t);break;case"node":i=this._invokeOne(function(n){return n.loadNode&&n.loadNode(t)});break;case"mesh":i=this._invokeOne(function(n){return n.loadMesh&&n.loadMesh(t)});break;case"accessor":i=this.loadAccessor(t);break;case"bufferView":i=this._invokeOne(function(n){return n.loadBufferView&&n.loadBufferView(t)});break;case"buffer":i=this.loadBuffer(t);break;case"material":i=this._invokeOne(function(n){return n.loadMaterial&&n.loadMaterial(t)});break;case"texture":i=this._invokeOne(function(n){return n.loadTexture&&n.loadTexture(t)});break;case"skin":i=this.loadSkin(t);break;case"animation":i=this._invokeOne(function(n){return n.loadAnimation&&n.loadAnimation(t)});break;case"camera":i=this.loadCamera(t);break;default:if(i=this._invokeOne(function(n){return n!=this&&n.getDependency&&n.getDependency(e,t)}),!i)throw new Error("Unknown type: "+e);break}this.cache.add(s,i)}return i}getDependencies(e){let t=this.cache.get(e);if(!t){const s=this,i=this.json[e+(e==="mesh"?"es":"s")]||[];t=Promise.all(i.map(function(n,r){return s.getDependency(e,r)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],s=this.fileLoader;if(t.type&&t.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(t.uri===void 0&&e===0)return Promise.resolve(this.extensions[T.KHR_BINARY_GLTF].body);const i=this.options;return new Promise(function(n,r){s.load(Ee.resolveURL(t.uri,i.path),n,void 0,function(){r(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(s){const i=t.byteLength||0,n=t.byteOffset||0;return s.slice(n,n+i)})}loadAccessor(e){const t=this,s=this.json,i=this.json.accessors[e];if(i.bufferView===void 0&&i.sparse===void 0){const r=Ue[i.type],o=de[i.componentType],a=i.normalized===!0,h=new o(i.count*r);return Promise.resolve(new Ne(h,r,a))}const n=[];return i.bufferView!==void 0?n.push(this.getDependency("bufferView",i.bufferView)):n.push(null),i.sparse!==void 0&&(n.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),n.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(n).then(function(r){const o=r[0],a=Ue[i.type],h=de[i.componentType],l=h.BYTES_PER_ELEMENT,u=l*a,d=i.byteOffset||0,p=i.bufferView!==void 0?s.bufferViews[i.bufferView].byteStride:void 0,f=i.normalized===!0;let b,g;if(p&&p!==u){const A=Math.floor(d/p),E="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+A+":"+i.count;let w=t.cache.get(E);w||(b=new h(o,A*p,i.count*p/l),w=new rs(b,p/l),t.cache.add(E,w)),g=new vs(w,a,d%p/l,f)}else o===null?b=new h(i.count*a):b=new h(o,d,i.count*a),g=new Ne(b,a,f);if(i.sparse!==void 0){const A=Ue.SCALAR,E=de[i.sparse.indices.componentType],w=i.sparse.indices.byteOffset||0,_=i.sparse.values.byteOffset||0,B=new E(r[1],w,i.sparse.count*A),Z=new h(r[2],_,i.sparse.count*a);o!==null&&(g=new Ne(g.array.slice(),g.itemSize,g.normalized)),g.normalized=!1;for(let H=0,be=B.length;H<be;H++){const Q=B[H];if(g.setX(Q,Z[H*a]),a>=2&&g.setY(Q,Z[H*a+1]),a>=3&&g.setZ(Q,Z[H*a+2]),a>=4&&g.setW(Q,Z[H*a+3]),a>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}g.normalized=f}return g})}loadTexture(e){const t=this.json,s=this.options,n=t.textures[e].source,r=t.images[n];let o=this.textureLoader;if(r.uri){const a=s.manager.getHandler(r.uri);a!==null&&(o=a)}return this.loadTextureImage(e,n,o)}loadTextureImage(e,t,s){const i=this,n=this.json,r=n.textures[e],o=n.images[t],a=(o.uri||o.bufferView)+":"+r.sampler;if(this.textureCache[a])return this.textureCache[a];const h=this.loadImageSource(t,s).then(function(l){l.flipY=!1,l.name=r.name||o.name||"",l.name===""&&typeof o.uri=="string"&&o.uri.startsWith("data:image/")===!1&&(l.name=o.uri);const d=(n.samplers||{})[r.sampler]||{};return l.magFilter=mt[d.magFilter]||Ve,l.minFilter=mt[d.minFilter]||Ct,l.wrapS=gt[d.wrapS]||We,l.wrapT=gt[d.wrapT]||We,l.generateMipmaps=!l.isCompressedTexture&&l.minFilter!==je&&l.minFilter!==Ve,i.associations.set(l,{textures:e}),l}).catch(function(){return null});return this.textureCache[a]=h,h}loadImageSource(e,t){const s=this,i=this.json,n=this.options;if(this.sourceCache[e]!==void 0)return this.sourceCache[e].then(u=>u.clone());const r=i.images[e],o=self.URL||self.webkitURL;let a=r.uri||"",h=!1;if(r.bufferView!==void 0)a=s.getDependency("bufferView",r.bufferView).then(function(u){h=!0;const d=new Blob([u],{type:r.mimeType});return a=o.createObjectURL(d),a});else if(r.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const l=Promise.resolve(a).then(function(u){return new Promise(function(d,p){let f=d;t.isImageBitmapLoader===!0&&(f=function(b){const g=new qe(b);g.needsUpdate=!0,d(g)}),t.load(Ee.resolveURL(u,n.path),f,void 0,p)})}).then(function(u){return h===!0&&o.revokeObjectURL(a),X(u,r),u.userData.mimeType=r.mimeType||zi(r.uri),u}).catch(function(u){throw console.error("THREE.GLTFLoader: Couldn't load texture",a),u});return this.sourceCache[e]=l,l}assignTexture(e,t,s,i){const n=this;return this.getDependency("texture",s.index).then(function(r){if(!r)return null;if(s.texCoord!==void 0&&s.texCoord>0&&(r=r.clone(),r.channel=s.texCoord),n.extensions[T.KHR_TEXTURE_TRANSFORM]){const o=s.extensions!==void 0?s.extensions[T.KHR_TEXTURE_TRANSFORM]:void 0;if(o){const a=n.associations.get(r);r=n.extensions[T.KHR_TEXTURE_TRANSFORM].extendTexture(r,o),n.associations.set(r,a)}}return i!==void 0&&(r.colorSpace=i),e[t]=r,r})}assignFinalMaterial(e){const t=e.geometry;let s=e.material;const i=t.attributes.tangent===void 0,n=t.attributes.color!==void 0,r=t.attributes.normal===void 0;if(e.isPoints){const o="PointsMaterial:"+s.uuid;let a=this.cache.get(o);a||(a=new os,Fe.prototype.copy.call(a,s),a.color.copy(s.color),a.map=s.map,a.sizeAttenuation=!1,this.cache.add(o,a)),s=a}else if(e.isLine){const o="LineBasicMaterial:"+s.uuid;let a=this.cache.get(o);a||(a=new Rt,Fe.prototype.copy.call(a,s),a.color.copy(s.color),a.map=s.map,this.cache.add(o,a)),s=a}if(i||n||r){let o="ClonedMaterial:"+s.uuid+":";i&&(o+="derivative-tangents:"),n&&(o+="vertex-colors:"),r&&(o+="flat-shading:");let a=this.cache.get(o);a||(a=s.clone(),n&&(a.vertexColors=!0),r&&(a.flatShading=!0),i&&(a.normalScale&&(a.normalScale.y*=-1),a.clearcoatNormalScale&&(a.clearcoatNormalScale.y*=-1)),this.cache.add(o,a),this.associations.set(a,this.associations.get(s))),s=a}e.material=s}getMaterialType(){return Pt}loadMaterial(e){const t=this,s=this.json,i=this.extensions,n=s.materials[e];let r;const o={},a=n.extensions||{},h=[];if(a[T.KHR_MATERIALS_UNLIT]){const u=i[T.KHR_MATERIALS_UNLIT];r=u.getMaterialType(),h.push(u.extendParams(o,n,t))}else{const u=n.pbrMetallicRoughness||{};if(o.color=new te(1,1,1),o.opacity=1,Array.isArray(u.baseColorFactor)){const d=u.baseColorFactor;o.color.setRGB(d[0],d[1],d[2],q),o.opacity=d[3]}u.baseColorTexture!==void 0&&h.push(t.assignTexture(o,"map",u.baseColorTexture,ve)),o.metalness=u.metallicFactor!==void 0?u.metallicFactor:1,o.roughness=u.roughnessFactor!==void 0?u.roughnessFactor:1,u.metallicRoughnessTexture!==void 0&&(h.push(t.assignTexture(o,"metalnessMap",u.metallicRoughnessTexture)),h.push(t.assignTexture(o,"roughnessMap",u.metallicRoughnessTexture))),r=this._invokeOne(function(d){return d.getMaterialType&&d.getMaterialType(e)}),h.push(Promise.all(this._invokeAll(function(d){return d.extendMaterialParams&&d.extendMaterialParams(e,o)})))}n.doubleSided===!0&&(o.side=Ot);const l=n.alphaMode||Ke.OPAQUE;if(l===Ke.BLEND?(o.transparent=!0,o.depthWrite=!1):(o.transparent=!1,l===Ke.MASK&&(o.alphaTest=n.alphaCutoff!==void 0?n.alphaCutoff:.5)),n.normalTexture!==void 0&&r!==oe&&(h.push(t.assignTexture(o,"normalMap",n.normalTexture)),o.normalScale=new C(1,1),n.normalTexture.scale!==void 0)){const u=n.normalTexture.scale;o.normalScale.set(u,u)}if(n.occlusionTexture!==void 0&&r!==oe&&(h.push(t.assignTexture(o,"aoMap",n.occlusionTexture)),n.occlusionTexture.strength!==void 0&&(o.aoMapIntensity=n.occlusionTexture.strength)),n.emissiveFactor!==void 0&&r!==oe){const u=n.emissiveFactor;o.emissive=new te().setRGB(u[0],u[1],u[2],q)}return n.emissiveTexture!==void 0&&r!==oe&&h.push(t.assignTexture(o,"emissiveMap",n.emissiveTexture,ve)),Promise.all(h).then(function(){const u=new r(o);return n.name&&(u.name=n.name),X(u,n),t.associations.set(u,{materials:e}),n.extensions&&se(i,u,n),u})}createUniqueName(e){const t=as.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,s=this.extensions,i=this.primitiveCache;function n(o){return s[T.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(o,t).then(function(a){return yt(a,o,t)})}const r=[];for(let o=0,a=e.length;o<a;o++){const h=e[o],l=Bi(h),u=i[l];if(u)r.push(u.promise);else{let d;h.extensions&&h.extensions[T.KHR_DRACO_MESH_COMPRESSION]?d=n(h):d=yt(new cs,h,t),i[l]={primitive:h,promise:d},r.push(d)}}return Promise.all(r)}loadMesh(e){const t=this,s=this.json,i=this.extensions,n=s.meshes[e],r=n.primitives,o=[];for(let a=0,h=r.length;a<h;a++){const l=r[a].material===void 0?Gi(this.cache):this.getDependency("material",r[a].material);o.push(l)}return o.push(t.loadGeometries(r)),Promise.all(o).then(function(a){const h=a.slice(0,a.length-1),l=a[a.length-1],u=[];for(let p=0,f=l.length;p<f;p++){const b=l[p],g=r[p];let A;const E=h[p];if(g.mode===F.TRIANGLES||g.mode===F.TRIANGLE_STRIP||g.mode===F.TRIANGLE_FAN||g.mode===void 0)A=n.isSkinnedMesh===!0?new hs(b,E):new tt(b,E),A.isSkinnedMesh===!0&&A.normalizeSkinWeights(),g.mode===F.TRIANGLE_STRIP?A.geometry=pt(A.geometry,vt):g.mode===F.TRIANGLE_FAN&&(A.geometry=pt(A.geometry,Ye));else if(g.mode===F.LINES)A=new St(b,E);else if(g.mode===F.LINE_STRIP)A=new ls(b,E);else if(g.mode===F.LINE_LOOP)A=new us(b,E);else if(g.mode===F.POINTS)A=new ds(b,E);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+g.mode);Object.keys(A.geometry.morphAttributes).length>0&&Ki(A,n),A.name=t.createUniqueName(n.name||"mesh_"+e),X(A,n),g.extensions&&se(i,A,g),t.assignFinalMaterial(A),u.push(A)}for(let p=0,f=u.length;p<f;p++)t.associations.set(u[p],{meshes:e,primitives:p});if(u.length===1)return n.extensions&&se(i,u[0],n),u[0];const d=new he;n.extensions&&se(i,d,n),t.associations.set(d,{meshes:e});for(let p=0,f=u.length;p<f;p++)d.add(u[p]);return d})}loadCamera(e){let t;const s=this.json.cameras[e],i=s[s.type];if(!i){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return s.type==="perspective"?t=new xe(Et.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):s.type==="orthographic"&&(t=new Lt(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),s.name&&(t.name=this.createUniqueName(s.name)),X(t,s),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],s=[];for(let i=0,n=t.joints.length;i<n;i++)s.push(this._loadNodeShallow(t.joints[i]));return t.inverseBindMatrices!==void 0?s.push(this.getDependency("accessor",t.inverseBindMatrices)):s.push(null),Promise.all(s).then(function(i){const n=i.pop(),r=i,o=[],a=[];for(let h=0,l=r.length;h<l;h++){const u=r[h];if(u){o.push(u);const d=new J;n!==null&&d.fromArray(n.array,h*16),a.push(d)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[h])}return new ps(o,a)})}loadAnimation(e){const t=this.json,s=this,i=t.animations[e],n=i.name?i.name:"animation_"+e,r=[],o=[],a=[],h=[],l=[];for(let u=0,d=i.channels.length;u<d;u++){const p=i.channels[u],f=i.samplers[p.sampler],b=p.target,g=b.node,A=i.parameters!==void 0?i.parameters[f.input]:f.input,E=i.parameters!==void 0?i.parameters[f.output]:f.output;b.node!==void 0&&(r.push(this.getDependency("node",g)),o.push(this.getDependency("accessor",A)),a.push(this.getDependency("accessor",E)),h.push(f),l.push(b))}return Promise.all([Promise.all(r),Promise.all(o),Promise.all(a),Promise.all(h),Promise.all(l)]).then(function(u){const d=u[0],p=u[1],f=u[2],b=u[3],g=u[4],A=[];for(let E=0,w=d.length;E<w;E++){const _=d[E],B=p[E],Z=f[E],H=b[E],be=g[E];if(_===void 0)continue;_.updateMatrix&&_.updateMatrix();const Q=s._createAnimationTracks(_,B,Z,H,be);if(Q)for(let Ie=0;Ie<Q.length;Ie++)A.push(Q[Ie])}return new fs(n,void 0,A)})}createNodeMesh(e){const t=this.json,s=this,i=t.nodes[e];return i.mesh===void 0?null:s.getDependency("mesh",i.mesh).then(function(n){const r=s._getNodeRef(s.meshCache,i.mesh,n);return i.weights!==void 0&&r.traverse(function(o){if(o.isMesh)for(let a=0,h=i.weights.length;a<h;a++)o.morphTargetInfluences[a]=i.weights[a]}),r})}loadNode(e){const t=this.json,s=this,i=t.nodes[e],n=s._loadNodeShallow(e),r=[],o=i.children||[];for(let h=0,l=o.length;h<l;h++)r.push(s.getDependency("node",o[h]));const a=i.skin===void 0?Promise.resolve(null):s.getDependency("skin",i.skin);return Promise.all([n,Promise.all(r),a]).then(function(h){const l=h[0],u=h[1],d=h[2];d!==null&&l.traverse(function(p){p.isSkinnedMesh&&p.bind(d,Yi)});for(let p=0,f=u.length;p<f;p++)l.add(u[p]);return l})}_loadNodeShallow(e){const t=this.json,s=this.extensions,i=this;if(this.nodeCache[e]!==void 0)return this.nodeCache[e];const n=t.nodes[e],r=n.name?i.createUniqueName(n.name):"",o=[],a=i._invokeOne(function(h){return h.createNodeMesh&&h.createNodeMesh(e)});return a&&o.push(a),n.camera!==void 0&&o.push(i.getDependency("camera",n.camera).then(function(h){return i._getNodeRef(i.cameraCache,n.camera,h)})),i._invokeAll(function(h){return h.createNodeAttachment&&h.createNodeAttachment(e)}).forEach(function(h){o.push(h)}),this.nodeCache[e]=Promise.all(o).then(function(h){let l;if(n.isBone===!0?l=new ms:h.length>1?l=new he:h.length===1?l=h[0]:l=new wt,l!==h[0])for(let u=0,d=h.length;u<d;u++)l.add(h[u]);if(n.name&&(l.userData.name=n.name,l.name=r),X(l,n),n.extensions&&se(s,l,n),n.matrix!==void 0){const u=new J;u.fromArray(n.matrix),l.applyMatrix4(u)}else n.translation!==void 0&&l.position.fromArray(n.translation),n.rotation!==void 0&&l.quaternion.fromArray(n.rotation),n.scale!==void 0&&l.scale.fromArray(n.scale);return i.associations.has(l)||i.associations.set(l,{}),i.associations.get(l).nodes=e,l}),this.nodeCache[e]}loadScene(e){const t=this.extensions,s=this.json.scenes[e],i=this,n=new he;s.name&&(n.name=i.createUniqueName(s.name)),X(n,s),s.extensions&&se(t,n,s);const r=s.nodes||[],o=[];for(let a=0,h=r.length;a<h;a++)o.push(i.getDependency("node",r[a]));return Promise.all(o).then(function(a){for(let l=0,u=a.length;l<u;l++)n.add(a[l]);const h=l=>{const u=new Map;for(const[d,p]of i.associations)(d instanceof Fe||d instanceof qe)&&u.set(d,p);return l.traverse(d=>{const p=i.associations.get(d);p!=null&&u.set(d,p)}),u};return i.associations=h(n),n})}_createAnimationTracks(e,t,s,i,n){const r=[],o=e.name?e.name:e.uuid,a=[];$[n.path]===$.weights?e.traverse(function(d){d.morphTargetInfluences&&a.push(d.name?d.name:d.uuid)}):a.push(o);let h;switch($[n.path]){case $.weights:h=ct;break;case $.rotation:h=ht;break;case $.position:case $.scale:h=at;break;default:switch(s.itemSize){case 1:h=ct;break;case 2:case 3:default:h=at;break}break}const l=i.interpolation!==void 0?Hi[i.interpolation]:jt,u=this._getArrayFromAccessor(s);for(let d=0,p=a.length;d<p;d++){const f=new h(a[d]+"."+$[n.path],t.array,u,l);i.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(f),r.push(f)}return r}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const s=$e(t.constructor),i=new Float32Array(t.length);for(let n=0,r=t.length;n<r;n++)i[n]=t[n]*s;t=i}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(s){const i=this instanceof ht?Fi:Kt;return new i(this.times,this.values,this.getValueSize()/3,s)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function Vi(c,e,t){const s=e.attributes,i=new kt;if(s.POSITION!==void 0){const o=t.json.accessors[s.POSITION],a=o.min,h=o.max;if(a!==void 0&&h!==void 0){if(i.set(new v(a[0],a[1],a[2]),new v(h[0],h[1],h[2])),o.normalized){const l=$e(de[o.componentType]);i.min.multiplyScalar(l),i.max.multiplyScalar(l)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const n=e.targets;if(n!==void 0){const o=new v,a=new v;for(let h=0,l=n.length;h<l;h++){const u=n[h];if(u.POSITION!==void 0){const d=t.json.accessors[u.POSITION],p=d.min,f=d.max;if(p!==void 0&&f!==void 0){if(a.setX(Math.max(Math.abs(p[0]),Math.abs(f[0]))),a.setY(Math.max(Math.abs(p[1]),Math.abs(f[1]))),a.setZ(Math.max(Math.abs(p[2]),Math.abs(f[2]))),d.normalized){const b=$e(de[d.componentType]);a.multiplyScalar(b)}o.max(a)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}i.expandByVector(o)}c.boundingBox=i;const r=new xs;i.getCenter(r.center),r.radius=i.min.distanceTo(i.max)/2,c.boundingSphere=r}function yt(c,e,t){const s=e.attributes,i=[];function n(r,o){return t.getDependency("accessor",r).then(function(a){c.setAttribute(o,a)})}for(const r in s){const o=Qe[r]||r.toLowerCase();o in c.attributes||i.push(n(s[r],o))}if(e.indices!==void 0&&!c.index){const r=t.getDependency("accessor",e.indices).then(function(o){c.setIndex(o)});i.push(r)}return ot.workingColorSpace!==q&&"COLOR_0"in s&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${ot.workingColorSpace}" not supported.`),X(c,e),Vi(c,e,t),Promise.all(i).then(function(){return e.targets!==void 0?Ui(c,e.targets,t):c})}async function bt(c){if(/\.(mp4|webm|ogg)$/i.test(c)){const t=await new Promise(s=>{const i=document.createElement("video");i.src=c,i.crossOrigin=!0,i.playsInline=!0,i.muted=!0,i.loop=!1,i.play(),i.addEventListener("playing",()=>{i.pause(),s(i)},{once:!0})});return new Ms(t)}else{const t=new Mt;return await new Promise(s=>t.load(c,i=>s(i),void 0,i=>console.error(i)))}}async function Wi(c){const e=new pi;return(await new Promise(s=>e.load(c,i=>s(i),void 0,i=>console.error(i)))).scene}function Bt(c){if(c.isGroup)return c.children.map(e=>Bt(e)).flat().filter(e=>e!=null);if(c.isMesh)return[c]}function U(c,e){switch(c){case"position":case"bounds":return e==null?void 0:e.split(" ").map(t=>+t);case"rotation":return[...e.split(" ").map(t=>+t),"YXZ"];case"layers":return[...e.matchAll(/'([^']+)'|"([^"]+)"|([^ ]+)/g)].map(t=>t[1]??t[2]??t[3]);case"fov":case"far":case"time":return+e;case"projection-type":return["perspective","orthographic","map"].includes(e)?e:"perspective";case"screen":case"focus":case"pass-through":case"first-person":case"follow-focus":case"show-camera-frame":return e===""||e==="true";case"controls":return e===""||e==="true"||e==="move"?"move":e==="edit"?"edit":!1;default:return e}}async function qi(c){const e=/\.glb$/.test(c),t=Bt(await Wi(c)),s=new he;s.name="vantage:base";const i=new Cs({color:15658734}),n=new Rt({color:0});t.forEach(h=>{e?Array.isArray(h.material)||(h.material=[h.material]):(h.geometry.clearGroups(),h.geometry.addGroup(0,1/0,0),h.material=[i])});const r=new he;e||(r.name="vantage:edges",r.add(...t.map(h=>new St(new Rs(h.geometry),n)))),s.add(...t,r);const o=new kt().setFromObject(s),a=[-o.min.x,-o.max.x,o.min.z,o.max.z];return{base:s,bounds:a}}function Zi(){const c=new he;c.name="vantage:lights",c.add(new Ps(16777215,.8));const e=new Xe(16777215,3),t=new Xe(16777215,3);return e.position.set(1,1,1),t.position.set(-1,-1,-1),c.add(e,t),c}function Qi(c){const e=Array.from(c.querySelectorAll("vantage-keyframe"));if(!e.length)return null;let t=e[0];return e.forEach(i=>{const n=+i.getAttribute("time")||0;n<=(+c.closest("vantage-renderer").getAttribute("time")||0)&&n>(+t.getAttribute("time")||0)&&(t=i)}),e.sort((i,n)=>+i.getAttribute("time")-+n.getAttribute("time")).findLast((i,n)=>{const r=+c.closest("vantage-renderer").getAttribute("time"),o=+c.getAttribute("time");return+i.getAttribute("time")+o<=r||n===0})}function re(c){const e=Array.from(c.querySelectorAll("vantage-keyframe")),t=document.getElementById("keyframeSelector");if(t&&t.options.length>0){const s=parseInt(t.value,10);if(!isNaN(s)&&e[s])return e[s]}return Qi(c)}const Se=.2,At=.2;var ae,we,P;class $i extends Os{constructor(t,{mapCameraPosition:s=[-100,50,50],domElement:i,scene:n,firstPerson:r,controls:o}){super();m(this,"mapCamera",new xe(60,innerWidth/innerHeight,1,1e4));m(this,"fpCamera",new xe(60,innerWidth/innerHeight,1,1e4));m(this,"mapControls");m(this,"projection");D(this,ae);D(this,we);D(this,P);m(this,"scene");m(this,"domElement");m(this,"focusMarker");m(this,"dragControls");m(this,"mouse",new C);m(this,"attachProjection",(t,s)=>{this.detachProjection();const i=s?this.fpCamera:t.camera,n=s?t.camera:this.fpCamera,r=i.getWorldPosition(new v),o=i.getWorldQuaternion(new ge);n.position.set(...r),n.setRotationFromQuaternion(o),n.updateProjectionMatrix(),this.projection=t,this.projection.focus(),s&&this.projection.update()});m(this,"detachProjection",()=>{var t;(t=this.projection)==null||t.blur(),this.projection=null});m(this,"keydown",({code:t})=>{if(this.controls&&!(this.firstPerson&&!this.fpControls.enabled))switch(t){case"KeyF":this.fpCamera.translateY(-At);break;case"KeyR":this.fpCamera.translateY(At);break;case"KeyW":{const s=this.fpCamera.position.y;this.fpCamera.translateZ(-Se),this.fpCamera.position.y=s;break}case"KeyA":{const s=this.fpCamera.position.y;this.fpCamera.translateX(-Se),this.fpCamera.position.y=s;break}case"KeyS":{const s=this.fpCamera.position.y;this.fpCamera.translateZ(Se),this.fpCamera.position.y=s;break}case"KeyD":{const s=this.fpCamera.position.y;this.fpCamera.translateX(Se),this.fpCamera.position.y=s;break}case"KeyQ":y(this,P).rotateZ(.02),this.dispatchEvent({type:"vantage:update-focus-camera",value:[...y(this,P).rotation].slice(0,-1)});break;case"KeyE":y(this,P).rotateZ(-.02),this.dispatchEvent({type:"vantage:update-focus-camera",value:[...y(this,P).rotation].slice(0,-1)});break}});m(this,"mousedown",()=>{!this.fpControls.enabled||y(this,P)==null||(this.fpControls.attachCamera(y(this,P)),window.addEventListener("mouseup",()=>{this.fpControls.detachCamera(),this.dispatchEvent({type:"vantage:update-focus-camera",value:[...y(this,P).rotation].slice(0,-1)})},{once:!0}))});m(this,"wheel",t=>{if(!this.fpControls.enabled||y(this,P)==null)return;this.fpControls.attachCamera(y(this,P));const s=t.deltaY*.05;y(this,P).fov+=s,y(this,P).fov=Math.max(0,Math.min(175,y(this,P).fov)),y(this,P).updateProjectionMatrix(),this.fpControls.detachCamera();const i=document.querySelector("vantage-renderer");if(!i)return;const n=Array.from(i.querySelectorAll("vantage-projection")).find(o=>o.hasAttribute("focus")&&o.getAttribute("focus")!=="false");if(!n)return;const r=re(n);r&&(r.setAttribute("fov",y(this,P).fov),this.dispatchEvent({type:"vantage:update-fov",value:y(this,P).fov}))});this.domElement=i,this.scene=n,this.mapCamera.position.set(...s),this.mapCamera.rotation.set(Math.PI/2,0,0,"YXZ"),this.mapControls=new ei(this.mapCamera,t.domElement),this.mapControls.minDistance=10,this.mapControls.maxDistance=1e3,this.fpControls=new ni(this.fpCamera,i),this.fpControls.addEventListener("unlock",()=>{this.map(),this.dispatchEvent({type:"vantage:unlock-first-person"})}),this.fpControls.addEventListener("change",()=>{}),this.fpControls.enabled=!1,this.firstPerson=r,this.controls=o,document.addEventListener("keydown",this.keydown),document.addEventListener("mousedown",this.mousedown),document.addEventListener("wheel",this.wheel),this.createFocusMarker()}set camera(t){if(I(this,P,t),!y(this,ae)||t==null)return;const s=t.getWorldPosition(new v),i=t.getWorldQuaternion(new ge);this.fpCamera.position.set(...s),this.fpCamera.setRotationFromQuaternion(i),this.fpCamera.updateProjectionMatrix()}get camera(){return y(this,ae)?this.fpCamera:this.mapCamera}set firstPerson(t){I(this,ae,t),t?this.fp():this.map()}get firstPerson(){return y(this,ae)}set controls(t){t&&(this.firstPerson?this.fp():this.map()),I(this,we,t)}get controls(){return y(this,we)}map(){!this.controls||this.mapControls.enabled||(this.mapControls.enabled=!0,this.fpControls.enabled=!1,this.fpControls.unlock())}fp(){!this.controls||this.fpControls.enabled||(this.mapControls.enabled=!1,this.fpControls.enabled=!0,this.fpControls.lock())}createFocusMarker(){const t=new Ss(1,16,16),s=new oe({color:65280,transparent:!0,opacity:1});this.focusMarker=new tt(t,s),this.focusMarker.name="FocusMarker",this.focusMarker.layers.set(2),this.scene.add(this.focusMarker),this.focusMarker.visible=!1}updateFocusMarker(t){const s=Object.values(t).find(i=>i.focus&&i.ready);s?(this.focusMarker.visible=!0,this.focusMarker.position.copy(s.camera.position)):this.focusMarker.visible=!1}focusOnCamera(t){const s=new ze;s.setFromCamera(this.mouse,this.mapCamera);let i=null,n=1/0;Object.values(t).forEach(r=>{if(r.attributes&&r.attributes["projection-type"]==="map")return;const o=r.plane||r.helper,a=s.intersectObject(o,!0);a.length>0&&a[0].distance<n&&(n=a[0].distance,i=r)}),i&&(Object.values(t).forEach(r=>{r.element.setAttribute("focus",r===i)}),i.element.dispatchEvent(new CustomEvent("vantage:set-focus",{bubbles:!0,detail:{id:i.id}})))}updateMouse(t){const s=this.domElement.getBoundingClientRect();this.mouse.x=(t.clientX-s.left)/s.width*2-1,this.mouse.y=-((t.clientY-s.top)/s.height)*2+1}initDragControls(t){this.dragControls&&(this.dragControls.dispose(),this.dragControls=null),this.dragControls=new ci([this.focusMarker],this.mapCamera,this.domElement),this.dragControls.raycaster.layers.enable(2),this.dragControls.addEventListener("dragstart",()=>{this.mapControls&&(this.mapControls.enabled=!1)}),this.dragControls.addEventListener("dragend",()=>{this.mapControls&&(this.mapControls.enabled=!0)}),this.dragControls.addEventListener("drag",()=>{const s=Object.values(t).find(l=>l.focus);if(!s)return;const i=new ze;i.setFromCamera(this.mouse,this.mapCamera);const n=new Je(new v(0,1,0),-s.camera.position.y),r=new v;i.ray.intersectPlane(n,r);const o=s.element.closest("vantage-renderer"),a=o?parseFloat(o.getAttribute("time")):0,h=s.element.selectActiveKeyframe(a);h&&(h.setAttribute("position",`${r.x} ${r.y} ${r.z}`),h.dispatchEvent(new CustomEvent("vantage:set-position",{bubbles:!0,detail:{position:[...r]}})))})}}ae=new WeakMap,we=new WeakMap,P=new WeakMap;var Ji=0;function ye(c){return"__private_"+Ji+++"_"+c}function M(c,e){if(!Object.prototype.hasOwnProperty.call(c,e))throw new TypeError("attempted to use private field on non-instance");return c}function Tt(c,e){let{defines:t="",header:s="",main:i="",...n}=e,r=c;const o=(h,l,u)=>h.split(l).join(u);return Object.keys(n).forEach(h=>{r=o(r,h,n[h])}),r=r.replace("void main() {",`
    ${s}
    void main() {
      ${i}
    `),`
    ${Object.keys(t).map(h=>`#define ${h} ${t[h]}`).join(`
`)}
    ${r}
  `}function _t(c,e){if(c.image&&c.image.videoWidth!==0&&c.image.videoHeight!==0)return;const t=setInterval(()=>{if(c.image&&c.image.videoWidth!==0&&c.image.videoHeight!==0)return clearInterval(t),e(c)},16)}var Y=ye("camera"),ie=ye("cover"),ne=ye("textureScale"),Te=ye("saveCameraProjectionMatrix"),S=ye("saveDimensions"),_e=ye("saveCameraMatrices");class en extends K{get camera(){return M(this,Y)[Y]}set camera(e){if(!e||!e.isCamera)throw new Error("Invalid camera set to the ProjectedMaterial");if(e.type!==M(this,Y)[Y].type)throw new Error("Cannot change camera type after the material has been created. Use another material.");M(this,Y)[Y]=e,M(this,S)[S]()}get texture(){return this.uniforms.projectedTexture.value}set texture(e){if(!(e!=null&&e.isTexture))throw new Error("Invalid texture set to the ProjectedMaterial");this.uniforms.projectedTexture.value=e,this.uniforms.isTextureLoaded.value=!!e.image,this.uniforms.isTextureLoaded.value?M(this,S)[S]():_t(e,()=>{this.uniforms.isTextureLoaded.value=!0,this.dispatchEvent({type:"textureload"}),M(this,S)[S]()})}get depthMap(){return this.uniforms.depthMap.value}set depthMap(e){if(!(e!=null&&e.isTexture))throw new Error("Invalid texture set to the ProjectedMaterial");this.uniforms.depthMap.value=e}get textureScale(){return M(this,ne)[ne]}set textureScale(e){M(this,ne)[ne]=e,M(this,S)[S]()}get textureOffset(){return this.uniforms.textureOffset.value}set textureOffset(e){this.uniforms.textureOffset.value=e}get backgroundOpacity(){return this.uniforms.backgroundOpacity.value}set backgroundOpacity(e){this.uniforms.backgroundOpacity.value=e,e<1&&!this.transparent&&console.warn('You have to pass "transparent: true" to the ProjectedMaterial for the backgroundOpacity option to work')}get cover(){return M(this,ie)[ie]}set cover(e){M(this,ie)[ie]=e,M(this,S)[S]()}constructor(e){let{camera:t=new xe,texture:s=new qe,textureScale:i=1,textureOffset:n=new C,backgroundOpacity:r=1,cover:o=!1,depthMap:a=null,...h}=e===void 0?{}:e;if(!s.isTexture)throw new Error("Invalid texture passed to the ProjectedMaterial");if(!t.isCamera)throw new Error("Invalid camera passed to the ProjectedMaterial");r<1&&!h.transparent&&console.warn('You have to pass "transparent: true" to the ProjectedMaterial for the backgroundOpacity option to work'),super(h),Object.defineProperty(this,_e,{value:sn}),Object.defineProperty(this,S,{value:tn}),Object.defineProperty(this,Y,{writable:!0,value:void 0}),Object.defineProperty(this,ie,{writable:!0,value:void 0}),Object.defineProperty(this,ne,{writable:!0,value:void 0}),Object.defineProperty(this,Te,{writable:!0,value:()=>{this.uniforms.projectionMatrixCamera.value.copy(this.camera.projectionMatrix),M(this,S)[S]()}}),Object.defineProperty(this,"isProjectedMaterial",{value:!0}),M(this,Y)[Y]=t,M(this,ie)[ie]=o,M(this,ne)[ne]=i;const[l,u]=zt(s,t,i,o);this.uniforms={projectedTexture:{value:s},isTextureLoaded:{value:!!s.image},isTextureProjected:{value:!1},backgroundOpacity:{value:r},viewMatrixCamera:{value:new J},projectionMatrixCamera:{value:new J},projPosition:{value:new v},projDirection:{value:new v(0,0,-1)},savedModelMatrix:{value:new J},widthScaled:{value:l},heightScaled:{value:u},textureOffset:{value:n},depthMap:{value:a},isOrthographicCamera:{value:this.camera.isOrthographicCamera}},this.onBeforeCompile=d=>{Object.assign(this.uniforms,d.uniforms),d.uniforms=this.uniforms,a&&(d.defines.STOP_PROPAGATION=""),d.vertexShader=Tt(d.vertexShader,{header:`
          uniform mat4 viewMatrixCamera;
          uniform mat4 projectionMatrixCamera;
          uniform bool isOrthographicCamera;

          #ifdef USE_INSTANCING
          attribute vec4 savedModelMatrix0;
          attribute vec4 savedModelMatrix1;
          attribute vec4 savedModelMatrix2;
          attribute vec4 savedModelMatrix3;
          #else
          uniform mat4 savedModelMatrix;
          #endif

          varying vec3 vSavedNormal;
          varying vec4 vTexCoords;
          // #ifndef ORTHOGRAPHIC
          varying vec4 vWorldPosition;
          // #endif
        `,main:`
          #ifdef USE_INSTANCING
          mat4 savedModelMatrix = mat4(
            savedModelMatrix0,
            savedModelMatrix1,
            savedModelMatrix2,
            savedModelMatrix3
          );
          #endif

          vSavedNormal = mat3(savedModelMatrix) * normal;
          vTexCoords = projectionMatrixCamera * viewMatrixCamera * savedModelMatrix * vec4(position, 1.0);
          // #ifndef ORTHOGRAPHIC
          if (!isOrthographicCamera) {
            vWorldPosition = savedModelMatrix * vec4(position, 1.0);
          }
          // #endif
        `}),d.fragmentShader=Tt(d.fragmentShader,{header:`
          uniform sampler2D projectedTexture;
          uniform sampler2D depthMap;
          uniform bool isTextureLoaded;
          uniform bool isTextureProjected;
          uniform float backgroundOpacity;
          uniform vec3 projPosition;
          uniform vec3 projDirection;
          uniform float widthScaled;
          uniform float heightScaled;
          uniform vec2 textureOffset;
          uniform mat4 projectionMatrixCamera;
          uniform bool isOrthographicCamera;

          varying vec3 vSavedNormal;
          varying vec4 vTexCoords;
          // #ifndef ORTHOGRAPHIC
          varying vec4 vWorldPosition;
          // #endif

          float mapRange(float value, float min1, float max1, float min2, float max2) {
            return min2 + (value - min1) * (max2 - min2) / (max1 - min1);
          }
        `,"vec4 diffuseColor = vec4( diffuse, opacity );":`
          // clamp the w to make sure we don't project behind
          float w = max(vTexCoords.w, 0.0);

          vec2 uv = (vTexCoords.xy / w) * 0.5 + 0.5;
          #ifdef STOP_PROPAGATION
          vec2 uvDepthMap = uv;
          #endif

          uv += textureOffset;

          // apply the corrected width and height
          uv.x = mapRange(uv.x, 0.0, 1.0, 0.5 - widthScaled / 2.0, 0.5 + widthScaled / 2.0);
          uv.y = mapRange(uv.y, 0.0, 1.0, 0.5 - heightScaled / 2.0, 0.5 + heightScaled / 2.0);

          // this makes sure we don't sample out of the texture
          bool isInTexture = (max(uv.x, uv.y) <= 1.0 && min(uv.x, uv.y) >= 0.0);

          // this makes sure we don't render also the back of the object
          vec3 projectorDirection;
          if (isOrthographicCamera) {
            projectorDirection = projDirection;
          } else {
            projectorDirection = normalize(projPosition - vWorldPosition.xyz);
          }
          float dotProduct = dot(vSavedNormal, projectorDirection);

          bool isFacingProjector = dotProduct > 0.0000001;

          bool isInShadow = false;
          #ifdef STOP_PROPAGATION
            vec4 depthMapColor = texture2D(depthMap, uvDepthMap);

            float depth = depthMapColor.x;

            if (isOrthographicCamera) {
              float z = (vTexCoords.z + 1.0) / 2.0;
              isInShadow = depth < z - 0.001 || z < 0.0 || z > 1.0;
            } else {
              float z_ndc = 2.0 * depth - 1.0;

              float a = projectionMatrixCamera[2][2];
              float b = projectionMatrixCamera[3][2];
              float z_eye = b / (a + z_ndc);

              isInShadow = vTexCoords.w > z_eye + 0.1 || depth == 1.0;
              // isInShadow = vTexCoords.w > 50.0;
              // isInShadow = depth > 0.98;
            }
          #endif

          vec4 diffuseColor = vec4(diffuse, opacity * backgroundOpacity);

          if (isFacingProjector && isInTexture && isTextureLoaded && isTextureProjected && !isInShadow) {
            vec4 textureColor = texture2D(projectedTexture, uv);
            // apply the material opacity
            textureColor.a *= opacity;

            // https://learnopengl.com/Advanced-OpenGL/Blending
            diffuseColor = textureColor * textureColor.a + diffuseColor * (1.0 - textureColor.a);
          }
        `})},window.addEventListener("resize",M(this,Te)[Te]),_t(s,()=>{this.uniforms.isTextureLoaded.value=!0,this.dispatchEvent({type:"textureload"}),M(this,S)[S]()})}project(e){if(!(Array.isArray(e.material)?e.material.some(t=>t.isProjectedMaterial):e.material.isProjectedMaterial))throw new Error("The mesh material must be a ProjectedMaterial");if(!(Array.isArray(e.material)?e.material.some(t=>t===this):e.material===this))throw new Error("The provided mesh doesn't have the same material as where project() has been called from");if(e.updateWorldMatrix(!0,!1),this.uniforms.savedModelMatrix.value.copy(e.matrixWorld),Array.isArray(e.material)){const t=e.material.indexOf(this);e.material[t].transparent||console.warn(`You have to pass "transparent: true" to the ProjectedMaterial if you're working with multiple materials.`),t>0&&(this.uniforms.backgroundOpacity.value=0)}M(this,_e)[_e]()}projectInstanceAt(e,t,s,i){let{forceCameraSave:n=!1}=i===void 0?{}:i;if(!t.isInstancedMesh)throw new Error("The provided mesh is not an InstancedMesh");if(!(Array.isArray(t.material)?t.material.every(r=>r.isProjectedMaterial):t.material.isProjectedMaterial))throw new Error("The InstancedMesh material must be a ProjectedMaterial");if(!(Array.isArray(t.material)?t.material.some(r=>r===this):t.material===this))throw new Error("The provided InstancedMeshhave't i samenclude thas e material where project() has been called from");if(!t.geometry.attributes.savedModelMatrix0||!t.geometry.attributes.savedModelMatrix1||!t.geometry.attributes.savedModelMatrix2||!t.geometry.attributes.savedModelMatrix3)throw new Error("No allocated data found on the geometry, please call 'allocateProjectionData(geometry, instancesCount)'");if(t.geometry.attributes.savedModelMatrix0.setXYZW(e,s.elements[0],s.elements[1],s.elements[2],s.elements[3]),t.geometry.attributes.savedModelMatrix1.setXYZW(e,s.elements[4],s.elements[5],s.elements[6],s.elements[7]),t.geometry.attributes.savedModelMatrix2.setXYZW(e,s.elements[8],s.elements[9],s.elements[10],s.elements[11]),t.geometry.attributes.savedModelMatrix3.setXYZW(e,s.elements[12],s.elements[13],s.elements[14],s.elements[15]),Array.isArray(t.material)){const r=t.material.indexOf(this);t.material[r].transparent||console.warn(`You have to pass "transparent: true" to the ProjectedMaterial if you're working with multiple materials.`),r>0&&(this.uniforms.backgroundOpacity.value=0)}(e===0||n)&&M(this,_e)[_e]()}copy(e){return super.copy(e),this.camera=e.camera,this.texture=e.texture,this.textureScale=e.textureScale,this.textureOffset=e.textureOffset,this.cover=e.cover,this}dispose(){super.dispose(),window.removeEventListener("resize",M(this,Te)[Te])}}function tn(){const[c,e]=zt(this.texture,this.camera,this.textureScale,this.cover);this.uniforms.widthScaled.value=c,this.uniforms.heightScaled.value=e}function sn(){this.camera.updateProjectionMatrix(),this.camera.updateMatrixWorld(),this.camera.updateWorldMatrix();const c=this.camera.matrixWorldInverse,e=this.camera.projectionMatrix,t=this.camera.matrixWorld;this.uniforms.viewMatrixCamera.value.copy(c),this.uniforms.projectionMatrixCamera.value.copy(e),this.uniforms.projPosition.value.setFromMatrixPosition(t),this.uniforms.projDirection.value.set(0,0,1).transformDirection(t),this.uniforms.isTextureProjected.value=!0}function nn(c){switch(c.type){case"PerspectiveCamera":return c.aspect;case"OrthographicCamera":{const e=Math.abs(c.right-c.left),t=Math.abs(c.top-c.bottom);return e/t}default:throw new Error(`${c.type} is currently not supported in ProjectedMaterial`)}}function zt(c,e,t,s){if(!c.image)return[1,1];if(c.image.videoWidth===0&&c.image.videoHeight===0)return[1,1];const i=c.image.naturalWidth||c.image.videoWidth||c.image.clientWidth,n=c.image.naturalHeight||c.image.videoHeight||c.image.clientHeight,r=i/n,o=nn(e),a=1,h=a*(1/o);let l,u;return(s?r>o:r<o)?(l=1/(h*r/a*t),u=1/t):(u=1/(a*(1/r)/h*t),l=1/t),[l,u]}var O,ce,pe,Me,fe,Ce,Re,me,De;class rn{constructor({renderer:e,scene:t,layers:s,texture:i,position:n=[0,1.8,0],rotation:r=[0,0,0,"YXZ"],fov:o=60,bounds:a,ratio:h=16/9,far:l,near:u=1,projectionType:d="perspective",textureSource:p,screen:f,attributes:b,id:g,focus:A,opacity:E,element:w,index:_}={}){m(this,"camera");D(this,O);D(this,ce);D(this,pe);D(this,Me);D(this,fe);m(this,"material",{});m(this,"helper",{});m(this,"renderer");m(this,"scene");m(this,"renderTarget");m(this,"plane");m(this,"textureSource");m(this,"attributes");m(this,"id");m(this,"ready",!1);D(this,Ce);D(this,Re);D(this,me);D(this,De,e=>{const t=new te(e);this.helper.setColors(t,t,t,t,t)});m(this,"createDepthMap",()=>{const e=this.helper.visible;this.helper.visible=!1;const t=this.plane.clone();this.scene.add(t),this.scene.getObjectByName("vantage:screens").visible=!1;const s=new Is({polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1});this.scene.overrideMaterial=s,this.renderer.setRenderTarget(this.renderTarget),this.renderer.render(this.scene,this.camera),this.renderer.setRenderTarget(null),this.scene.overrideMaterial=null,this.helper.visible=e,this.scene.getObjectByName("vantage:screens").visible=!0,this.scene.remove(t)});m(this,"updatePlane",()=>{if(this.plane==null)return;this.plane.rotation.set(...this.camera.rotation);const e=this.projectionType==="map"?[(this.camera.top+this.camera.bottom)/2,this.camera.position.y,(this.camera.right+this.camera.left)/2]:this.camera.position;this.plane.position.set(...e);const t=this.projectionType==="map"?[this.camera.right-this.camera.left,this.camera.top-this.camera.bottom]:this.camera.getViewSize(this.camera.far,new C);this.plane.scale.set(...t,1),this.plane.translateZ(-this.camera.far+this.camera.far*.001)});m(this,"getInterpolatedKeyframe",e=>{const t=parseFloat(this.element.getAttribute("time"))||0;let s=e-t;const n=Array.from(this.element.querySelectorAll("vantage-keyframe")).sort((f,b)=>parseFloat(f.getAttribute("time"))-parseFloat(b.getAttribute("time"))),r=parseFloat(n[0].getAttribute("time"))||0;s<r&&(s=r);let o=null,a=null;for(let f=0;f<n.length;f++)if((parseFloat(n[f].getAttribute("time"))||0)<=s)o=n[f];else{a=n[f];break}if(!o)return null;if(!a)return{position:o.getAttribute("position")||"0 0 0",rotation:o.getAttribute("rotation")||"0 0 0",fov:o.getAttribute("fov"),far:o.getAttribute("far"),opacity:o.getAttribute("opacity")};const h=parseFloat(o.getAttribute("time"))||0,l=parseFloat(a.getAttribute("time"))||0,u=(s-h)/(l-h),d=(f,b,g)=>f+(b-f)*g,p=(f,b)=>{const g=(f||"0 0 0").split(" ").map(Number),A=(b||"0 0 0").split(" ").map(Number);return g.map((E,w)=>d(E,A[w],u)).join(" ")};return{position:p(o.getAttribute("position"),a.getAttribute("position")),rotation:p(o.getAttribute("rotation"),a.getAttribute("rotation")),fov:d(parseFloat(o.getAttribute("fov"))||0,parseFloat(a.getAttribute("fov"))||0,u),far:d(parseFloat(o.getAttribute("far"))||0,parseFloat(a.getAttribute("far"))||0,u),opacity:d(parseFloat(o.getAttribute("opacity"))||1,parseFloat(a.getAttribute("opacity"))||1,u)}});m(this,"updateCameraFromKeyframe",e=>{if(this.projectionType==="map"){let r,o;!e.position||e.position.trim()===""||e.position.trim()==="0 0 0"?r=[0,500,0]:r=e.position.split(" ").map(Number),!e.rotation||e.rotation.trim()===""||e.rotation.trim()==="0 0 0"?o=[-Math.PI/2,Math.PI,0]:o=e.rotation.split(" ").map(Number),this.camera.position.set(...r),this.camera.rotation.set(...o),this.camera.updateProjectionMatrix();return}const t=e.position.split(" ").map(Number),s=e.rotation.split(" ").map(Number),i=parseFloat(e.fov),n=parseFloat(e.far);this.camera.position.set(...t),this.camera.rotation.set(...s),isNaN(i)||(this.camera.fov=i,this.camera.updateProjectionMatrix()),isNaN(n)||(this.camera.far=n,this.camera.updateProjectionMatrix())});m(this,"update",()=>{if(!this.ready||this.scene.getObjectByName("vantage:base")==null)return;const e=this.element.closest("vantage-renderer"),t=e?parseFloat(e.getAttribute("time")):0,s=parseFloat(this.element.getAttribute("time"))||0;if(t<s){this.hideProjection();return}const i=this.getInterpolatedKeyframe(t);if(!i){this.hideProjection();return}this.updateCameraFromKeyframe(i),this.updatePlane(),this.createDepthMap(),this.helper.update(),this.updateMaterials(),this.updateVideo(t)});m(this,"updateVideo",e=>{if(!this.texture||!this.texture.source||!(this.texture.source.data instanceof HTMLVideoElement))return;const t=this.texture.source.data;if(!t.duration||t.readyState<2)return;t.pause();const s=parseFloat(this.element.getAttribute("time"))||0;let i=e-s;i<0&&(i=0),t.currentTime=i});m(this,"updateLayers",()=>{Object.entries(y(this,O)).forEach(([e])=>{e!=="vantage:screen"&&(this.material[e].visible=y(this,ce)==null||y(this,ce).includes(e))})});this.id=g,this.renderer=e,this.scene=t,I(this,pe,a),this.element=w,this.attributes=b,this.offset=parseFloat(w.getAttribute("time"))||0,this.index=_,this.projectionType=d,l=l??(this.projectionType==="map"?501:150),this.projectionType==="map"?(this.camera=new Lt(...a??[100,-100,-100,100],0,l),this.position=[0,500,0],this.rotation=[-Math.PI/2,Math.PI,0,"YXZ"]):this.projectionType==="orthographic"?(this.position=n,this.rotation=r):(this.camera=new xe(o,h,u,l),this.position=n,this.rotation=r),this.renderTarget=new Ls(2e3,2e3),this.renderTarget.texture.format=js,this.renderTarget.texture.minFilter=je,this.renderTarget.texture.magFilter=je,this.renderTarget.texture.generateMipmaps=!1,this.renderTarget.stencilBuffer=!1,this.renderTarget.depthTexture=new lt,this.renderTarget.depthBuffer=!0,this.renderTarget.depthTexture=new lt,this.renderTarget.depthTexture.type=ks,this.texture=i,this.textureSource=p,this.opacity=E,this.createLayers(),this.screen=f,this.layers=s,this.helper=new Ds(this.camera),y(this,De).call(this,65280),this.helper.layers.set(2),this.focus=A,this.ready=!0}set index(e){I(this,me,e+1),Object.keys(this.material).forEach(t=>{t!=="vantage-renderer"&&(y(this,O)[t].material[e+1]=this.material[t])})}get index(){return y(this,me)-1}set layers(e){I(this,ce,e),this.updateLayers()}get layers(){return y(this,ce)}set bounds({bounds:e,auto:t}){this.projectionType!=="map"||e==null||(t||I(this,pe,e),this.camera.left=e[0],this.camera.right=e[1],this.camera.top=e[2],this.camera.bottom=e[3],this.update())}get bounds(){return y(this,pe)}set position(e){this.camera.position.set(...e),this.update()}get position(){return this.camera.position}set rotation(e){this.camera.rotation.set(...e),this.update()}get rotation(){return this.camera.rotation}set fov(e){this.camera.fov=e,this.camera.updateProjectionMatrix(),this.update()}get fov(){return this.camera.fov}set far(e){this.camera.far=e,this.camera.updateProjectionMatrix(),this.update()}get far(){return this.camera.far}set texture(e){I(this,Me,e);for(const t in y(this,O))this.material[t].texture=e;this.update()}get texture(){return y(this,Me)}set screen(e){I(this,fe,e===!0),this.plane&&(this.plane.visible=y(this,fe)),this.update()}get screen(){return y(this,fe)}set focus(e){var n,r;I(this,Ce,e);const t=(r=(n=this.element)==null?void 0:n.closest)==null?void 0:r.call(n,"vantage-renderer"),s=t==null?void 0:t.getAttribute("controls"),i=(t==null?void 0:t.getAttribute("show-camera-frame"))==="true";this.helper.visible=e===!0&&(s==="edit"||i)}get focus(){return y(this,Ce)}set opacity(e){I(this,Re,e||1),Object.values(this.material).forEach(t=>{t.transparent=!0,t.opacity=e,t.needsUpdate=!0})}get opacity(){return y(this,Re)}selectActiveKeyframe(e){const t=parseFloat(this.element.getAttribute("time"))||0,s=e-t,i=Array.from(this.element.querySelectorAll("vantage-keyframe")),n=i.filter(r=>parseFloat(r.getAttribute("time"))<=s);return n.length===0?i[0]:n.reduce((r,o)=>parseFloat(o.getAttribute("time"))>parseFloat(r.getAttribute("time"))?o:r)}hideProjection(){this.plane&&(this.plane.visible=!1);for(const e in y(this,O))e!=="vantage:screen"&&this.material[e]&&(this.material[e].visible=!1)}updateMaterials(){for(const e in y(this,O))this.material[e]&&(this.material[e].visible=!0,this.material[e].project(y(this,O)[e]))}createLayers(){var e;I(this,O,Object.fromEntries(((e=this.scene.getObjectByName("vantage:base"))==null?void 0:e.children.filter(({isMesh:t})=>t).map(t=>[t.name,t]))??[])),this.plane==null&&(this.plane=new tt(new Ns(1,1),[]),this.plane.geometry.addGroup(0,1/0,0),this.plane.material.push(new oe({transparent:!0,opacity:.9,color:16777215,side:Ot})),this.plane.renderOrder=1,this.scene.getObjectByName("vantage:screens").add(this.plane)),y(this,O)["vantage:screen"]=this.plane;for(const t in y(this,O))this.material[t]=new en({camera:this.camera,texture:this.texture,transparent:!0,opacity:this.opacity,depthMap:this.renderTarget.depthTexture}),y(this,O)[t].geometry.addGroup(0,1/0,y(this,O)[t].geometry.groups.length),t==="vantage:screen"?y(this,O)[t].material.push(this.material[t]):y(this,O)[t].material[y(this,me)]=this.material[t];this.updateLayers()}destroy(){var e;Object.values(this.material).forEach(t=>{t.visible=!1,t.dispose()}),this.texture.dispose(),this.camera.removeFromParent(),(e=this.plane)==null||e.removeFromParent(),this.helper.removeFromParent()}}O=new WeakMap,ce=new WeakMap,pe=new WeakMap,Me=new WeakMap,fe=new WeakMap,Ce=new WeakMap,Re=new WeakMap,me=new WeakMap,De=new WeakMap;class Yt extends HTMLElement{constructor(){super();m(this,"root");m(this,"scene",new Fs);m(this,"renderer",new Hs);m(this,"cameraOperator");m(this,"meshes");m(this,"bounds");m(this,"projections",{});m(this,"controls",!1);m(this,"showCameraFrame",!1);m(this,"mousePressed",!0);m(this,"lastRotation",null);m(this,"mouse",new C);m(this,"initialKeyframeRotation",null);m(this,"initialCameraRotation",null);m(this,"followFocus",!1);m(this,"update",()=>{const t=parseFloat(this.getAttribute("time"))||0,s=Object.values(this.projections).find(i=>i.focus);s&&s.ready?(this.handleCameraUpdate(s,t),this.updateFocusMarkerAndControls(s,t)):this.hideFocusMarkerAndDisposeDrag(),this.renderScene()});m(this,"updateFocusCamera",()=>{if(this.controls!=="edit"||!this.cameraOperator.firstPerson)return;const t=Object.values(this.projections).find(({focus:n})=>n);if(!t)return;const s=this.cameraOperator.camera.getWorldPosition(new v),i=re(t.element);i&&(i.setAttribute("position",`${s.x} ${s.y} ${s.z}`),i.dispatchEvent(new CustomEvent("vantage:set-position",{bubbles:!0,detail:{position:[...s]}})))});m(this,"updateFocusRotation",()=>{if(this.controls!=="edit"||!this.cameraOperator.firstPerson||!this.mousePressed||!this.initialKeyframeRotation||!this.initialCameraRotation)return;this.cameraOperator.fpCamera.rotation.setFromQuaternion(this.cameraOperator.fpCamera.quaternion,"YXZ");const s=[...this.cameraOperator.fpCamera.rotation].slice(0,3).map((o,a)=>o-this.initialCameraRotation[a]),i=this.initialKeyframeRotation.map((o,a)=>o+s[a]),n=Object.values(this.projections).find(({focus:o})=>o);if(!n)return;const r=re(n.element);r&&(r.setAttribute("rotation",i.join(" ")),r.dispatchEvent(new CustomEvent("vantage:set-rotation",{bubbles:!0,detail:{rotation:i}})))})}async attributeChangedCallback(t,s,i){var r,o;const n=U(t,i);switch(t){case"scene":{const{base:a,bounds:h}=await qi(n);(r=this.scene.getObjectByName("vantage:base"))==null||r.removeFromParent(),this.scene.add(a),this.bounds=h,Object.values(this.projections).forEach(l=>{l.bounds==null&&(l.bounds={bounds:h,auto:!0}),l.createLayers(),l.update()});break}case"first-person":if(!this.cameraOperator)return;this.cameraOperator.firstPerson=n,this.cameraOperator.camera=(o=Object.values(this.projections).find(({focus:a})=>a))==null?void 0:o.camera;break;case"follow-focus":this.followFocus=n;break;case"show-camera-frame":this.showCameraFrame=n,Object.values(this.projections).forEach(a=>{a.focus=!!a.focus});break;case"controls":if(this.controls=n,!this.cameraOperator)return;this.cameraOperator.controls=n,Object.values(this.projections).forEach(a=>{a.focus=!!a.focus});break;case"time":Object.values(this.projections).forEach(({element:a})=>{a.updateTime(n)});break}}async connectedCallback(){var n,r;this.renderer.setPixelRatio(window.devicePixelRatio);const t=this.attachShadow({mode:"open"}),s=document.createElement("style");s.innerHTML=":host {display: block; height: 100%; width: 100%; overflow: hidden}",t.appendChild(s),this.renderer.domElement.style="display: block; width: 100%; height: 100%;",t.appendChild(this.renderer.domElement),this.renderer.domElement.addEventListener("pointermove",o=>{const a=this.renderer.domElement.getBoundingClientRect();this.mouse.x=(o.clientX-a.left)/a.width*2-1,this.mouse.y=-((o.clientY-a.top)/a.height)*2+1,this.cameraOperator&&this.cameraOperator.updateMouse(o)}),this.renderer.setAnimationLoop(this.update),this.resizeObserver=new ResizeObserver(o=>this.resizeCanvas(o[0].contentRect)),this.resizeObserver.observe(this.renderer.domElement),this.addEventListener("vantage:add-projection",o=>this.addProjection(o.detail)),this.addEventListener("vantage:update-projection",o=>this.updateProjection(o.detail)),this.addEventListener("vantage:update-projection-multi",o=>{const{id:a,attributes:h}=o.detail;Object.entries(h).forEach(([l,u])=>this.updateProjection({id:a,property:l,value:u}))}),this.addEventListener("vantage:remove-projection",o=>this.removeProjection(o.detail)),this.addEventListener("mousedown",()=>{this.mousePressed=!0;const o=Object.values(this.projections).find(({focus:a})=>a);if(o){const a=re(o.element);a&&(this.initialKeyframeRotation=a.getAttribute("rotation").split(" ").map(Number),this.cameraOperator.fpCamera.rotation.setFromQuaternion(this.cameraOperator.fpCamera.quaternion,"YXZ"),this.initialCameraRotation=[...this.cameraOperator.fpCamera.rotation].slice(0,3))}this.addEventListener("mouseup",()=>{this.mousePressed=!1,this.initialKeyframeRotation=null,this.initialCameraRotation=null},{once:!0})}),this.cameraOperator=new $i(this.renderer,{mapCameraPosition:[-100,50,50],domElement:this,scene:this.scene,firstPerson:U("first-person",(n=this.attributes["first-person"])==null?void 0:n.value),controls:U("controls",(r=this.attributes.controls)==null?void 0:r.value)}),this.cameraOperator.addEventListener("vantage:update-focus-camera",({value:o})=>{if(this.controls!=="edit"||!this.cameraOperator.firstPerson)return;const a=Array.from(document.querySelectorAll("vantage-projection")).find(l=>l.hasAttribute("focus")&&l.getAttribute("focus")!=="false");if(!a)return;const h=re(a);h&&(h.setAttribute("rotation",o.join(" ")),h.dispatchEvent(new CustomEvent("vantage:set-rotation",{bubbles:!0,detail:{rotation:o}})))}),this.cameraOperator.addEventListener("vantage:update-fov",({value:o})=>{if(this.controls!=="edit"||!this.cameraOperator.firstPerson)return;const a=Array.from(document.querySelectorAll("vantage-projection")).find(l=>l.hasAttribute("focus")&&l.getAttribute("focus")!=="false");if(!a)return;const h=re(a);h&&(h.setAttribute("fov",o),h.dispatchEvent(new CustomEvent("vantage:set-fov",{bubbles:!0,detail:{fov:o}})))}),this.cameraOperator.addEventListener("vantage:unlock-first-person",()=>{this.setAttribute("first-person","false"),this.dispatchEvent(new CustomEvent("vantage:unlock-first-person",{bubbles:!0}))});const i=new he;i.name="vantage:screens",this.scene.add(Zi(),i)}resizeCanvas({width:t,height:s}){var i,n,r;t>0&&s>0&&(this.renderer.setSize(t,s,!1),(n=(i=this.cameraOperator)==null?void 0:i.camera)!=null&&n.isPerspectiveCamera&&(this.cameraOperator.camera.aspect=t/s,this.cameraOperator.camera.updateProjectionMatrix()),(r=this.cameraOperator)!=null&&r.camera&&this.renderer.render(this.scene,this.cameraOperator.camera))}handleCameraUpdate(t,s){if(this.cameraOperator.firstPerson)this.controls==="edit"?(this.cameraOperator.fpControls.enabled=!0,this.cameraOperator.dragControls||this.cameraOperator.initDragControls(this.projections),this.updateFocusCamera(),this.updateFocusRotation(),this.syncCamera(this.cameraOperator.fpCamera)):this.syncCamera(t.camera);else{const i=t.getInterpolatedKeyframe(s);i&&(t.updateCameraFromKeyframe(i),this.followFocus&&this.syncCamera(t.camera))}}updateFocusMarkerAndControls(t,s){const i=this.controls==="edit"||this.showCameraFrame;if(this.cameraOperator.focusMarker.visible=i,i&&this.cameraOperator.focusMarker.position.copy(t.camera.position),this.controls!=="edit"){this.cameraOperator.dragControls&&this.disposeDragControls();return}if(this.cameraOperator.firstPerson){const n=re(t.element),r=n?parseFloat(n.getAttribute("time")):0;s===r&&!this.cameraOperator.dragControls?this.cameraOperator.initDragControls(this.projections):s!==r&&this.cameraOperator.dragControls&&this.disposeDragControls()}else this.cameraOperator.dragControls||this.cameraOperator.initDragControls(this.projections)}hideFocusMarkerAndDisposeDrag(){this.cameraOperator.focusMarker&&(this.cameraOperator.focusMarker.visible=!1),this.cameraOperator.dragControls&&this.disposeDragControls()}syncCamera(t){const s=this.cameraOperator.camera;s.position.copy(t.position),s.quaternion.copy(t.quaternion),t.fov&&(s.fov=t.fov,s.updateProjectionMatrix())}disposeDragControls(){this.cameraOperator.dragControls.dispose(),this.cameraOperator.dragControls=null}renderScene(){this.renderer.clearDepth(),this.cameraOperator.camera.layers.enable(2),this.renderer.render(this.scene,this.cameraOperator.camera)}async addProjection({id:t,attributes:s,element:i}){const n=await bt(s.src),r=n.source.data.videoWidth??n.source.data.width,o=n.source.data.videoHeight??n.source.data.height,a=Array.prototype.indexOf.call(this.children,i);Object.values(this.projections).forEach(l=>{l.index>=a&&l.index});const h=new rn({id:t,index:a,attributes:s,renderer:this.renderer,scene:this.scene,layers:s.layers,texture:n,position:s.position,rotation:s.rotation,bounds:s.bounds??this.bounds,fov:s.fov,ratio:r/o,far:s.far,projectionType:s["projection-type"],screen:s.screen,focus:s.focus,opacity:s.opacity,passThrough:s["pass-through"],element:i});h.update(),this.scene.add(h.helper),s.focus&&(this.cameraOperator.camera=h.camera),this.projections[t]=h,i.updateTime(U("time",this.getAttribute("time")??0))}async updateProjection({id:t,property:s,value:i}){const n=this.projections[t];if(n!=null)switch(s){case"src":{const r=await bt(i);n.texture=r;break}case"bounds":n.bounds=i?{bounds:i,auto:!1}:{bounds:this.bounds,auto:!0};break;case"focus":this.cameraOperator.camera=n.camera,n[s]=i;break;default:n[s]=i}}removeProjection({id:t}){const s=this.projections[t].index;this.projections[t].destroy(),delete this.projections[t],Object.values(this.projections).forEach(i=>{i.index>s&&i.index--})}getFocusProjectionInterpolation(t){t=t??parseFloat(this.getAttribute("time"));const s=Object.values(this.projections).find(i=>i.focus);if(s){const i=s.getInterpolatedKeyframe(t);s.element.dispatchEvent(new CustomEvent("vantage:create-keyframe",{bubbles:!0,detail:{far:+i.far,fov:+i.fov,position:i.position.split(" ").map(n=>+n),rotation:i.rotation.split(" ").map(n=>+n),time:t}}))}}}m(Yt,"observedAttributes",["scene","first-person","follow-focus","show-camera-frame","controls","time"]);class Xt extends HTMLElement{constructor(){super(),this.root=null,this.projectionId=null,this.rendererTime=null,this.keyframes={},this.offset=0}async attributeChangedCallback(e,t,s){if(this.projectionId!=null){if(e==="projection-type"){this.destroy(),this.create();return}e==="time"&&(this.offset=parseFloat(s)||0),this.dispatchEvent(new CustomEvent("vantage:update-projection",{bubbles:!0,detail:{id:this.projectionId,property:e,value:U(e,s),oldValue:U(e,t)}}))}}async connectedCallback(){var e;this.projectionId=this.id||((e=crypto==null?void 0:crypto.randomUUID)==null?void 0:e.call(crypto).split("-")[0])||`k-${Math.random()}`,this.vantageRenderer=this.parentElement,this.rendererTime=U("time",this.parentElement.getAttribute("time")??0),this.offset=parseFloat(this.getAttribute("time"))||0,this.addEventListener("vantage:add-keyframe",t=>this.addKeyframe(t.detail)),this.addEventListener("vantage:update-keyframe",t=>this.updateKeyframe(t.detail)),this.addEventListener("vantage:remove-keyframe",t=>this.removeKeyframe(t.detail)),this.create()}create(){const e=Object.fromEntries([...this.attributes].map(({name:s,value:i})=>[s,U(s,i)])),t=new CustomEvent("vantage:add-projection",{bubbles:!0,detail:{id:this.projectionId,element:this,attributes:e}});this.dispatchEvent(t)}disconnectedCallback(){this.destroy()}destroy(){const e=new CustomEvent("vantage:remove-projection",{bubbles:!0,detail:{id:this.projectionId}});this.vantageRenderer.dispatchEvent(e)}updateTime(e){this.rendererTime=e,this.update()}async addKeyframe({id:e,attributes:t}){this.keyframes[e]=t,this.update()}async updateKeyframe({id:e,property:t,value:s}){this.keyframes[e][t]=s,this.update()}selectActiveKeyframe(e){return Array.from(this.querySelectorAll("vantage-keyframe")).sort((i,n)=>+i.getAttribute("time")-+n.getAttribute("time")).findLast((i,n)=>{const r=+this.getAttribute("time");return+i.getAttribute("time")+r<=e||n===0})}removeKeyframe({id:e}){delete this.keyframes[e],this.update()}updateActiveKeyframeFromTransform(){const e=this.querySelector("vantage-keyframe");if(!e)return;const t=this.camera.position,s=this.camera.rotation;e.setAttribute("position",`${t.x} ${t.y} ${t.z}`),e.setAttribute("rotation",`${s.x} ${s.y} ${s.z}`),e.setAttribute("fov",this.camera.fov),e.setAttribute("far",this.camera.far)}update(){if(Object.keys(this.keyframes).length===0)return;const e=Object.values(this.keyframes).toSorted((s,i)=>s.time-i.time),t=e.findLast(({time:s})=>s<=this.rendererTime)??e[0];this.dispatchEvent(new CustomEvent("vantage:update-projection-multi",{bubbles:!0,detail:{id:this.projectionId,attributes:t}}))}}m(Xt,"observedAttributes",["src","position","rotation","projection-type","fov","far","screen","layers","bounds","focus","opacity","pass-through","time"]);class Vt extends HTMLElement{constructor(){super(),this.root=null,this.keyframeId=null}async attributeChangedCallback(e,t,s){this.keyframeId!=null&&this.dispatchEvent(new CustomEvent("vantage:update-keyframe",{bubbles:!0,detail:{id:this.keyframeId,property:e,value:U(e,s),oldValue:U(e,t)}}))}async connectedCallback(){var e;this.keyframeId=this.id||((e=crypto==null?void 0:crypto.randomUUID)==null?void 0:e.call(crypto).split("-")[0])||`k-${Math.random()}`,this.vantageProjection=this.parentElement,this.create()}create(){const e=Object.fromEntries([...this.attributes].map(({name:s,value:i})=>[s,U(s,i)])),t=new CustomEvent("vantage:add-keyframe",{bubbles:!0,detail:{id:this.keyframeId,element:this,attributes:e}});this.dispatchEvent(t)}disconnectedCallback(){this.destroy()}destroy(){const e=new CustomEvent("vantage:remove-keyframe",{bubbles:!0,detail:{id:this.keyframeId}});this.vantageProjection.dispatchEvent(e)}}m(Vt,"observedAttributes",["position","rotation","fov","far","screen","bounds","focus","opacity","pass-through","time"]);customElements.define("vantage-renderer",Yt);customElements.define("vantage-projection",Xt);customElements.define("vantage-keyframe",Vt);export{Yt as default};
